# Daikin Fit Enhanced Monitoring - Template Sensors
# Add to configuration.yaml: template: !include daikin_template_sensors.yaml

- sensor:
    # HVAC Action as separate entity (for history_stats)
    - name: "Daikin HVAC Action"
      unique_id: daikin_hvac_action
      state: "{{ state_attr('climate.daikin', 'hvac_action') }}"
      icon: >
        {% set action = state_attr('climate.daikin', 'hvac_action') %}
        {% if action == 'cooling' %}mdi:snowflake
        {% elif action == 'heating' %}mdi:fire
        {% elif action == 'idle' %}mdi:power-sleep
        {% else %}mdi:hvac
        {% endif %}

    # Total Power (Indoor + Outdoor)
    - name: "Daikin Total Power"
      unique_id: daikin_total_power
      state: >
        {% set outdoor = states('sensor.main_room_outdoor_power') | float(0) %}
        {% set indoor = states('sensor.main_room_indoor_power') | float(0) %}
        {{ (outdoor + indoor) | round(0) }}
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:lightning-bolt

    # Temperature Delta (Setpoint vs Actual)
    - name: "Daikin Temperature Delta"
      unique_id: daikin_temp_delta
      state: >
        {% set current = state_attr('climate.daikin', 'current_temperature') | float(0) %}
        {% set target = state_attr('climate.daikin', 'temperature') | float(0) %}
        {{ (current - target) | round(1) }}
      unit_of_measurement: "°F"
      device_class: temperature
      icon: mdi:thermometer-lines

    # Current Setpoint (easier to graph)
    - name: "Daikin Setpoint"
      unique_id: daikin_setpoint
      state: "{{ state_attr('climate.daikin', 'temperature') | float(0) | round(1) }}"
      unit_of_measurement: "°F"
      device_class: temperature
      state_class: measurement
      icon: mdi:thermostat

    # System Status (human readable)
    - name: "Daikin System Status"
      unique_id: daikin_system_status
      state: >
        {% set action = state_attr('climate.daikin', 'hvac_action') %}
        {% set mode = states('climate.daikin') %}
        {% if mode == 'off' %}
          Off
        {% elif action == 'cooling' %}
          Cooling
        {% elif action == 'heating' %}
          Heating
        {% elif action == 'idle' %}
          Idle ({{ mode | title }} mode)
        {% else %}
          {{ action | title }}
        {% endif %}
      icon: >
        {% set action = state_attr('climate.daikin', 'hvac_action') %}
        {% if action == 'cooling' %}mdi:snowflake
        {% elif action == 'heating' %}mdi:fire
        {% elif action == 'idle' %}mdi:fan
        {% else %}mdi:hvac-off
        {% endif %}

    # Compressor Efficiency Indicator
    - name: "Daikin Compressor Load"
      unique_id: daikin_compressor_load
      state: "{{ states('sensor.main_room_outdoor_frequency_in_percent') | float(0) | round(1) }}"
      unit_of_measurement: "%"
      icon: >
        {% set freq = states('sensor.main_room_outdoor_frequency_in_percent') | float(0) %}
        {% if freq > 80 %}mdi:speedometer
        {% elif freq > 50 %}mdi:speedometer-medium
        {% else %}mdi:speedometer-slow
        {% endif %}

    # Power per Degree (Efficiency metric)
    - name: "Daikin Efficiency"
      unique_id: daikin_efficiency
      state: >
        {% set power = states('sensor.daikin_total_power') | float(0) %}
        {% set delta = states('sensor.daikin_temperature_delta') | float(0) | abs %}
        {% if power > 100 and delta > 0.5 %}
          {{ (power / delta) | round(0) }}
        {% else %}
          0
        {% endif %}
      unit_of_measurement: "W/°F"
      icon: mdi:chart-line

    # Filter Days Remaining
    - name: "Daikin Filter Days"
      unique_id: daikin_filter_days
      state: "{{ state_attr('climate.daikin', 'media_filter_days') | int(0) }}"
      unit_of_measurement: "days"
      icon: >
        {% set days = state_attr('climate.daikin', 'media_filter_days') | int(0) %}
        {% if days < 7 %}mdi:air-filter-alert
        {% elif days < 30 %}mdi:air-filter
        {% else %}mdi:air-filter
        {% endif %}

    # Cooling Demand (from climate attributes)
    - name: "Daikin Cooling Demand"
      unique_id: daikin_cooling_demand
      state: "{{ state_attr('climate.daikin', 'cooling_demand') | float(0) | round(1) }}"
      unit_of_measurement: "%"
      icon: mdi:snowflake

    # Heating Demand (from climate attributes)
    - name: "Daikin Heating Demand"
      unique_id: daikin_heating_demand
      state: "{{ state_attr('climate.daikin', 'heating_demand') | float(0) | round(1) }}"
      unit_of_measurement: "%"
      icon: mdi:fire

    # Fan Demand (from climate attributes)
    - name: "Daikin Fan Demand"
      unique_id: daikin_fan_demand
      state: "{{ state_attr('climate.daikin', 'fan_demand') | float(0) | round(1) }}"
      unit_of_measurement: "%"
      icon: mdi:fan

    # Blower Airflow (from climate attributes)
    - name: "Daikin Blower CFM"
      unique_id: daikin_blower_cfm
      state: "{{ state_attr('climate.daikin', 'fan_cfm') | int(0) }}"
      unit_of_measurement: "CFM"
      icon: mdi:weather-windy

    # Is Running Binary (for automations)
    - name: "Daikin Is Running"
      unique_id: daikin_is_running
      state: >
        {% set action = state_attr('climate.daikin', 'hvac_action') %}
        {{ 'on' if action in ['cooling', 'heating'] else 'off' }}
      icon: >
        {% set action = state_attr('climate.daikin', 'hvac_action') %}
        {{ 'mdi:power' if action in ['cooling', 'heating'] else 'mdi:power-off' }}

# Binary sensor for easier runtime tracking
- binary_sensor:
    - name: "Daikin Running"
      unique_id: daikin_running
      state: "{{ state_attr('climate.daikin', 'hvac_action') in ['cooling', 'heating'] }}"
      device_class: running

    - name: "Daikin Cooling"
      unique_id: daikin_cooling
      state: "{{ state_attr('climate.daikin', 'hvac_action') == 'cooling' }}"

    - name: "Daikin Heating"
      unique_id: daikin_heating
      state: "{{ state_attr('climate.daikin', 'hvac_action') == 'heating' }}"

    - name: "Daikin Filter Alert"
      unique_id: daikin_filter_alert
      state: "{{ state_attr('climate.daikin', 'media_filter_days') | int(0) < 7 }}"
      device_class: problem
