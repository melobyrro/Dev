# Kia EV9 Scripts
# Version: 2.6
# Last Updated: 2026-01-25
#
# CHANGES from v2.5:
# - ev9_start_climate_with_timer now includes response verification:
#   - Waits 45s after command, then force_update, then waits 90s
#   - Checks binary_sensor.ev9_air_conditioner to verify climate started
#   - Retries once if not started
#   - Timer only starts if climate verified running
#   - Notification reflects actual SUCCESS or FAILED status
#
# CHANGES from v2.1 (retained):
# - Added charging control wrapper scripts (ev9_start_charge, ev9_stop_charge, ev9_force_update)
#   These scripts use the centralized device_id helper, allowing dashboard buttons to work
#   even after integration recreation
#
# CHANGES from v2.0 (retained):
# - Centralized device_id: All kia_uvo service calls now use
#   {{ states('input_text.ev9_device_id') }} instead of hardcoded ID
#
# CHANGES from v1.4 (retained):
# - Added ev9_clear_event_log script for clearing automation history
#
# DEPLOYMENT:
# 1. Ensure input_text.ev9_device_id helper is created (see helpers.v2.5.yaml)
# 2. Add these scripts to your scripts.yaml or create via UI
# 3. Reload scripts: Settings -> Automations -> Reload

# ============================================================
# CLIMATE WITH TIMER (v2.6 - with verification)
# ============================================================

ev9_start_climate_with_timer:
  alias: "EV9: Start Climate with Timer"
  description: "Start climate control with verification and auto-stop timer"
  icon: mdi:air-conditioner
  mode: single
  sequence:
    - variables:
        target_temp: "{{ states('input_number.ev9_target_temperature') | int(72) }}"
        duration_min: "{{ states('input_number.ev9_climate_duration') | int(15) }}"
        device_id: "{{ states('input_text.ev9_device_id') }}"

    # Attempt 1: Start climate
    - service: kia_uvo.start_climate
      data:
        device_id: "{{ device_id }}"
        climate: true
        temperature: "{{ target_temp }}"

    - service: python_script.shift_event_log
      data:
        entity_prefix: input_text.ev9_event
        max_events: 10
        new_event: "{{ now().strftime('%H:%M') }} - CLIMATE_CMD: Manual start command sent (attempt 1)"

    # Wait for car to respond
    - delay:
        seconds: 45

    # Force data refresh
    - service: kia_uvo.force_update
      data:
        device_id: "{{ device_id }}"

    # Wait for data to arrive
    - delay:
        seconds: 90

    # Verify climate started
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.ev9_air_conditioner
              state: "on"
          sequence:
            # SUCCESS - start timer and notify
            - service: timer.start
              data:
                duration: "{{ duration_min * 60 }}"
              target:
                entity_id: timer.ev9_climate_timer
            - service: python_script.shift_event_log
              data:
                entity_prefix: input_text.ev9_event
                max_events: 10
                new_event: "{{ now().strftime('%H:%M') }} - CLIMATE_SUCCESS: Climate verified running, {{ target_temp }}°F"
            - service: notify.mobile_app_andre_iphone
              data:
                title: "EV9 Climate Started"
                message: "Climate confirmed running. Target: {{ target_temp }}°F, Timer: {{ duration_min }} min"
      default:
        # Retry - Attempt 2
        - service: python_script.shift_event_log
          data:
            entity_prefix: input_text.ev9_event
            max_events: 10
            new_event: "{{ now().strftime('%H:%M') }} - CLIMATE_RETRY: Climate not detected, retrying..."
        - service: kia_uvo.start_climate
          data:
            device_id: "{{ device_id }}"
            climate: true
            temperature: "{{ target_temp }}"
        - delay:
            seconds: 120
        - service: kia_uvo.force_update
          data:
            device_id: "{{ device_id }}"
        - delay:
            seconds: 90
        - choose:
            - conditions:
                - condition: state
                  entity_id: binary_sensor.ev9_air_conditioner
                  state: "on"
              sequence:
                - service: timer.start
                  data:
                    duration: "{{ duration_min * 60 }}"
                  target:
                    entity_id: timer.ev9_climate_timer
                - service: python_script.shift_event_log
                  data:
                    entity_prefix: input_text.ev9_event
                    max_events: 10
                    new_event: "{{ now().strftime('%H:%M') }} - CLIMATE_SUCCESS: Climate started on retry"
                - service: notify.mobile_app_andre_iphone
                  data:
                    title: "EV9 Climate Started (Retry)"
                    message: "Climate confirmed running after retry. Target: {{ target_temp }}°F"
          default:
            - service: python_script.shift_event_log
              data:
                entity_prefix: input_text.ev9_event
                max_events: 10
                new_event: "{{ now().strftime('%H:%M') }} - CLIMATE_FAILED: Climate did not start after 2 attempts"
            - service: notify.mobile_app_andre_iphone
              data:
                title: "EV9 Climate FAILED"
                message: "Climate did not start after 2 attempts. Check car connectivity."

# ============================================================
# STOP CLIMATE AND CANCEL TIMER
# ============================================================

ev9_stop_climate_cancel_timer:
  alias: "EV9: Stop Climate and Cancel Timer"
  description: "Stop climate control and cancel any running timer"
  icon: mdi:fan-off
  mode: single
  sequence:
    - service: kia_uvo.stop_climate
      data:
        device_id: "{{ states('input_text.ev9_device_id') }}"
    - service: timer.cancel
      target:
        entity_id: timer.ev9_climate_timer
    - service: python_script.shift_event_log
      data:
        entity_prefix: input_text.ev9_event
        max_events: 10
        new_event: "{{ now().strftime('%H:%M') }} - CLIMATE_MANUAL_STOP: User stopped climate"

# ============================================================
# CHARGING CONTROL WRAPPERS (v2.5)
# Dashboard buttons cannot use templates, so these scripts
# provide indirection via the ev9_device_id helper.
# ============================================================

ev9_start_charge:
  alias: "EV9: Start Charging"
  description: "Start EV charging using centralized device_id"
  icon: mdi:ev-station
  mode: single
  sequence:
    - service: kia_uvo.start_charge
      data:
        device_id: "{{ states('input_text.ev9_device_id') }}"
    - service: python_script.shift_event_log
      data:
        entity_prefix: input_text.ev9_event
        max_events: 10
        new_event: "{{ now().strftime('%H:%M') }} - CHARGE_START: Manual start"

ev9_stop_charge:
  alias: "EV9: Stop Charging"
  description: "Stop EV charging using centralized device_id"
  icon: mdi:ev-station
  mode: single
  sequence:
    - service: kia_uvo.stop_charge
      data:
        device_id: "{{ states('input_text.ev9_device_id') }}"
    - service: python_script.shift_event_log
      data:
        entity_prefix: input_text.ev9_event
        max_events: 10
        new_event: "{{ now().strftime('%H:%M') }} - CHARGE_STOP: Manual stop"

ev9_force_update:
  alias: "EV9: Force Data Refresh"
  description: "Force vehicle data update using centralized device_id"
  icon: mdi:refresh
  mode: single
  sequence:
    - service: kia_uvo.force_update
      data:
        device_id: "{{ states('input_text.ev9_device_id') }}"
    - service: python_script.shift_event_log
      data:
        entity_prefix: input_text.ev9_event
        max_events: 10
        new_event: "{{ now().strftime('%H:%M') }} - DATA_REFRESH: Manual refresh"

# ============================================================
# CLEAR EVENT LOG
# ============================================================

ev9_clear_event_log:
  alias: "EV9: Clear Event Log"
  description: "Clear all event log entries"
  icon: mdi:delete
  mode: single
  sequence:
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_1
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_2
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_3
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_4
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_5
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_6
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_7
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_8
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_9
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_event_10
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_last_walkaway_result
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_last_timeout_lock_result
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.ev9_last_precondition_result
      data:
        value: ""
