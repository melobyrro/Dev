# Kia EV9 Dashboard
# Version: 2.0
# Last Updated: 2026-01-19
#
# CHANGES from v1.3:
# - Restructured to 3 tabs: Main (operations), Config (settings), Logs (events)
# - Removed Start/Stop/Refresh buttons from Main charging card (moved to Config)
# - Added time remaining hh:mm format
# - Increased charging graph height to 350px with fixed 0-1.5kW L1 scale
# - Merged Walk-Away + Timeout into Proximity Security card
# - Per-schedule temperatures with compact circular day monograms
# - Consolidated Alerts & Safety card
# - Read-only Logs tab with hybrid format (summary + 10 events)
# - Inline "Logic & Info" documentation per card
#
# REQUIREMENTS:
# - ApexCharts Card (HACS)
# - Button Card (HACS)
# - Stack-in-Card (HACS, optional)
#
# DEPLOYMENT:
# 1. Create new dashboard: Settings -> Dashboards -> Add Dashboard
# 2. Edit dashboard -> Raw configuration editor
# 3. Paste this entire file

views:
  # ============================================================
  # VIEW 1: MAIN (Operations Only - DSH-18)
  # ============================================================
  - title: Main
    path: main
    icon: mdi:car-electric
    cards:

      # ============================================================
      # BATTERY CARD
      # ============================================================
      - type: vertical-stack
        cards:
          - type: horizontal-stack
            cards:
              - type: gauge
                entity: sensor.ev9_ev_battery_level
                name: Battery
                min: 0
                max: 100
                severity:
                  green: 50
                  yellow: 20
                  red: 10
                needle: true

              - type: vertical-stack
                cards:
                  - type: entity
                    entity: sensor.ev9_ev_range
                    name: Range
                    icon: mdi:road-variant

                  - type: entity
                    entity: sensor.ev9_car_battery_level
                    name: 12V Battery
                    icon: mdi:car-battery

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Battery %**: High-voltage traction battery state of charge.

              **Range**: Estimated miles based on charge and driving patterns.

              **12V Battery**: Auxiliary battery health. Below 50% may cause issues.

              *Data refreshes every ~30 minutes via Kia Connect.*
              </details>

      # ============================================================
      # CHARGING CARD (Read-only on Main - DSH-21, DSH-22, DSH-23)
      # ============================================================
      - type: conditional
        conditions:
          - condition: state
            entity: binary_sensor.ev9_ev_battery_plug
            state: "on"
        card:
          type: vertical-stack
          cards:
            - type: markdown
              content: "## Charging Status"

            - type: horizontal-stack
              cards:
                - type: entity
                  entity: sensor.ev9_ev_charging_power
                  name: Power
                  icon: mdi:flash
                  unit: kW

                - type: custom:button-card
                  entity: sensor.ev9_estimated_charge_duration
                  name: Time Left
                  icon: mdi:timer-outline
                  show_state: true
                  show_icon: true
                  show_name: true
                  layout: vertical
                  styles:
                    card:
                      - padding: 12px
                    state:
                      - font-size: 18px
                      - font-weight: bold
                  state_display: |
                    [[[
                      var mins = parseInt(entity.state) || 0;
                      var h = Math.floor(mins / 60);
                      var m = mins % 60;
                      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
                    ]]]

            - type: entities
              entities:
                - entity: binary_sensor.ev9_ev_battery_charge
                  name: Charging Active
                - entity: number.ev9_ac_charging_limit
                  name: AC Limit
                - entity: number.ev9_dc_charging_limit
                  name: DC Limit

            # Charging History Graph (350px height, 0-1.5kW L1 scale)
            - type: custom:apexcharts-card
              header:
                title: Charging History (7 Days)
                show: true
              graph_span: 7d
              apex_config:
                chart:
                  height: 350
                tooltip:
                  x:
                    format: "ddd MMM d, HH:mm"
                legend:
                  show: true
                  position: top
              yaxis:
                - id: battery
                  min: 0
                  max: 100
                  decimals: 0
                  apex_config:
                    title:
                      text: "Battery %"
                    labels:
                      style:
                        colors: "#4CAF50"
                - id: power
                  opposite: true
                  min: 0
                  max: 1.5
                  decimals: 2
                  apex_config:
                    title:
                      text: "Power (kW)"
                    labels:
                      style:
                        colors: "#FF9800"
              series:
                - entity: sensor.ev9_ev_battery_level
                  name: Battery Level
                  yaxis_id: battery
                  color: "#4CAF50"
                  stroke_width: 2
                  group_by:
                    func: avg
                    duration: 30min
                - entity: sensor.ev9_l2_charging_power
                  name: Charging Power
                  yaxis_id: power
                  color: "#FF9800"
                  stroke_width: 2
                  group_by:
                    func: avg
                    duration: 30min

            - type: markdown
              content: |
                <details>
                <summary><b>Logic & Info</b></summary>

                **Charging states**: Active (drawing power), Stopped (plugged but not charging), Complete.

                **Time remaining**: Calculated by Kia based on current power and target %.

                **Graph scale**: Fixed 0-1.5 kW for Level 1 charging visibility.

                *Start/Stop/Refresh controls are in the Config tab.*
                </details>

      # ============================================================
      # CLIMATE CARD
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Climate Control"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                name: Start Climate
                icon: mdi:air-conditioner
                tap_action:
                  action: call-service
                  service: script.ev9_start_climate_with_timer
                styles:
                  card:
                    - background-color: var(--primary-color)
                    - color: white
                  icon:
                    - color: white

              - type: custom:button-card
                name: Stop Climate
                icon: mdi:fan-off
                tap_action:
                  action: call-service
                  service: script.ev9_stop_climate_cancel_timer
                styles:
                  card:
                    - background-color: var(--error-color)
                    - color: white
                  icon:
                    - color: white

          - type: entities
            entities:
              - entity: binary_sensor.ev9_air_conditioner
                name: Climate Active
              - entity: timer.ev9_climate_timer
                name: Auto-Stop Timer
              - entity: input_number.ev9_climate_duration
                name: Duration

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Start Climate**: Starts AC/heat with auto-stop timer.

              **Duration**: How long climate runs before auto-shutoff.

              **Timer**: Shows countdown. Climate stops when timer expires.

              *Pre-conditioning schedules are configured in the Config tab.*
              </details>

      # ============================================================
      # SECURITY CARD
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Security"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: lock.ev9_door_lock
                name: Lock
                icon: mdi:lock
                tap_action:
                  action: call-service
                  service: lock.lock
                  service_data:
                    entity_id: lock.ev9_door_lock
                styles:
                  card:
                    - background-color: var(--success-color)
                    - color: white
                  icon:
                    - color: white

              - type: custom:button-card
                entity: lock.ev9_door_lock
                name: Unlock
                icon: mdi:lock-open
                tap_action:
                  action: call-service
                  service: lock.unlock
                  service_data:
                    entity_id: lock.ev9_door_lock
                  confirmation:
                    text: "Unlock the vehicle?"
                styles:
                  card:
                    - background-color: var(--warning-color)
                    - color: white
                  icon:
                    - color: white

          - type: entities
            entities:
              - entity: binary_sensor.ev9_locked
                name: Lock Status
                secondary_info: last-changed

          - type: markdown
            content: |
              **Last Walk-Away**: {{ states('input_text.ev9_last_walkaway_result') or 'None' }}

              **Last Timeout Lock**: {{ states('input_text.ev9_last_timeout_lock_result') or 'None' }}

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Walk-Away Lock**: Auto-locks when your phone moves beyond set distance from vehicle (GPS-based).

              **Timeout Lock**: Auto-locks if vehicle stays unlocked for too long (failsafe).

              *Configure thresholds in the Config tab.*
              </details>

      # ============================================================
      # VEHICLE STATUS CARD
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Vehicle Status"

          - type: glance
            title: Doors & Openings
            columns: 4
            show_state: false
            entities:
              - entity: binary_sensor.ev9_front_left_door
                name: FL
              - entity: binary_sensor.ev9_front_right_door
                name: FR
              - entity: binary_sensor.ev9_back_left_door
                name: BL
              - entity: binary_sensor.ev9_back_right_door
                name: BR
              - entity: binary_sensor.ev9_trunk
                name: Trunk
              - entity: binary_sensor.ev9_hood
                name: Hood

          - type: entities
            entities:
              - entity: sensor.ev9_odometer
                name: Odometer
              - entity: sensor.ev9_last_updated_at
                name: Last Update
                format: relative

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Doors/Openings**: Real-time status from Kia Connect. Orange = open.

              **Last Update**: When vehicle data was last refreshed.

              *Doors and windows are status-only (not remotely controllable).*
              </details>

      # ============================================================
      # MAP CARD
      # ============================================================
      - type: map
        entities:
          - entity: device_tracker.ev9_location
        dark_mode: true
        default_zoom: 15
        aspect_ratio: 16:9

  # ============================================================
  # VIEW 2: CONFIG (All Settings - DSH-13)
  # ============================================================
  - title: Config
    path: config
    icon: mdi:cog
    cards:

      # ============================================================
      # PROXIMITY SECURITY CARD (DSH-20)
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Proximity Security"

          - type: entities
            title: Walk-Away Lock
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_walk_away_lock_enabled
                name: Enabled
              - entity: input_number.ev9_walkaway_distance
                name: Distance Threshold
              - entity: sensor.ev9_phone_distance
                name: Current Phone Distance

          - type: entities
            title: Timeout Failsafe
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_timeout_lock_enabled
                name: Enabled
              - entity: input_number.ev9_unlock_timeout
                name: Timeout Duration

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Walk-Away Lock** (AUT-09):
              - Triggers when phone GPS moves beyond distance threshold from vehicle
              - Default: 5 meters
              - Range: 1-20 meters
              - Note: GPS accuracy is ~3-10m, so very low thresholds may cause false triggers

              **Timeout Failsafe** (AUT-10):
              - Triggers when vehicle stays unlocked for longer than timeout
              - Default: 30 minutes
              - Range: 5-120 minutes
              - Acts as backup if walk-away doesn't trigger

              **How they interact**: Either can lock the vehicle independently. Both log to the Logs tab.

              **What they WON'T do**: They won't lock if the engine is running (you're driving).
              </details>

      # ============================================================
      # PRECONDITIONING CARD (DSH-24)
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Pre-conditioning"

          - type: entities
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_precondition_enabled
                name: Enabled
              - entity: input_boolean.ev9_smart_precondition
                name: Smart Mode (Weather-Based)

          - type: markdown
            content: |
              **Outside Temp**: {{ state_attr('weather.forecast_home', 'temperature') | default('--') }}F
              {% set outside = state_attr('weather.forecast_home', 'temperature') | float(72) %}
              {% set target = states('input_number.ev9_target_temperature') | float(72) %}
              {% set lead = ((outside - target) | abs * 0.5) | round(0) %}
              **Calculated Lead Time**: {{ lead }} min (based on temp difference)

          # Schedule 1
          - type: markdown
            content: "### Schedule 1"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_enabled
                show_name: false
                show_state: false
                icon: mdi:power
                styles:
                  card:
                    - width: 40px
                    - height: 40px
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      icon:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: var(--disabled-color)
                tap_action:
                  action: toggle

              - type: entity
                entity: input_datetime.ev9_schedule_1_time
                name: Time

              - type: entity
                entity: input_number.ev9_schedule_1_temperature
                name: Temp

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_mon
                name: M
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_tue
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_wed
                name: W
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_thu
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_fri
                name: F
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_sat
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_1_sun
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle

          # Schedule 2
          - type: markdown
            content: "### Schedule 2"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_enabled
                show_name: false
                show_state: false
                icon: mdi:power
                styles:
                  card:
                    - width: 40px
                    - height: 40px
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      icon:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: var(--disabled-color)
                tap_action:
                  action: toggle

              - type: entity
                entity: input_datetime.ev9_schedule_2_time
                name: Time

              - type: entity
                entity: input_number.ev9_schedule_2_temperature
                name: Temp

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_mon
                name: M
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_tue
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_wed
                name: W
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_thu
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_fri
                name: F
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_sat
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_2_sun
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle

          # Schedule 3
          - type: markdown
            content: "### Schedule 3"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_enabled
                show_name: false
                show_state: false
                icon: mdi:power
                styles:
                  card:
                    - width: 40px
                    - height: 40px
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      icon:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: var(--disabled-color)
                tap_action:
                  action: toggle

              - type: entity
                entity: input_datetime.ev9_schedule_3_time
                name: Time

              - type: entity
                entity: input_number.ev9_schedule_3_temperature
                name: Temp

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_mon
                name: M
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_tue
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_wed
                name: W
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_thu
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_fri
                name: F
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_sat
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_3_sun
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle

          # Schedule 4
          - type: markdown
            content: "### Schedule 4"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_enabled
                show_name: false
                show_state: false
                icon: mdi:power
                styles:
                  card:
                    - width: 40px
                    - height: 40px
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      icon:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: var(--disabled-color)
                tap_action:
                  action: toggle

              - type: entity
                entity: input_datetime.ev9_schedule_4_time
                name: Time

              - type: entity
                entity: input_number.ev9_schedule_4_temperature
                name: Temp

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_mon
                name: M
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_tue
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_wed
                name: W
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_thu
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_fri
                name: F
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_sat
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_4_sun
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle

          # Schedule 5
          - type: markdown
            content: "### Schedule 5"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_enabled
                show_name: false
                show_state: false
                icon: mdi:power
                styles:
                  card:
                    - width: 40px
                    - height: 40px
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      icon:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: var(--disabled-color)
                tap_action:
                  action: toggle

              - type: entity
                entity: input_datetime.ev9_schedule_5_time
                name: Time

              - type: entity
                entity: input_number.ev9_schedule_5_temperature
                name: Temp

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_mon
                name: M
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_tue
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_wed
                name: W
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_thu
                name: T
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_fri
                name: F
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_sat
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle
              - type: custom:button-card
                entity: input_boolean.ev9_schedule_5_sun
                name: S
                show_state: false
                styles:
                  card:
                    - width: 32px
                    - height: 32px
                    - border-radius: 50%
                    - font-size: 12px
                  name:
                    - font-weight: bold
                state:
                  - value: "on"
                    styles:
                      card:
                        - background-color: var(--primary-color)
                      name:
                        - color: white
                  - value: "off"
                    styles:
                      card:
                        - background-color: transparent
                        - border: 1px solid var(--disabled-color)
                      name:
                        - color: var(--disabled-text-color)
                tap_action:
                  action: toggle

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **How it works** (AUT-04):
              1. Automation checks every minute
              2. Loops through schedules 1-5 (priority order)
              3. Checks: Is schedule enabled? Is today selected? Is it time to start?
              4. First matching schedule wins

              **Smart Mode**: Adds extra lead time based on temperature difference.
              Formula: `abs(outside - target) * 0.5` minutes

              **Per-schedule temperature**: Each schedule can have its own target.

              **What it WON'T do**: Won't start if engine is running or 12V battery is low.
              </details>

      # ============================================================
      # CHARGING ADVANCED CARD
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Charging Controls"

          - type: horizontal-stack
            cards:
              - type: custom:button-card
                name: Start
                icon: mdi:play-circle
                tap_action:
                  action: call-service
                  service: kia_uvo.start_charge
                  service_data:
                    device_id: 7f6b71f10dc261408a02149c68aa3e23
                styles:
                  card:
                    - background-color: var(--success-color)
                    - color: white
                  icon:
                    - color: white

              - type: custom:button-card
                name: Stop
                icon: mdi:stop-circle
                tap_action:
                  action: call-service
                  service: kia_uvo.stop_charge
                  service_data:
                    device_id: 7f6b71f10dc261408a02149c68aa3e23
                  confirmation:
                    text: "Stop charging?"
                styles:
                  card:
                    - background-color: var(--error-color)
                    - color: white
                  icon:
                    - color: white

              - type: custom:button-card
                name: Refresh
                icon: mdi:refresh
                tap_action:
                  action: call-service
                  service: kia_uvo.force_update
                  service_data:
                    device_id: 7f6b71f10dc261408a02149c68aa3e23
                styles:
                  card:
                    - background-color: var(--primary-color)
                    - color: white
                  icon:
                    - color: white

          - type: entities
            title: Charge Settings
            show_header_toggle: false
            entities:
              - entity: number.ev9_ac_charging_limit
                name: AC Charge Limit
              - entity: number.ev9_dc_charging_limit
                name: DC Charge Limit
              - entity: input_number.ev9_expected_charge_power
                name: Expected Power (kW)
              - entity: input_number.ev9_low_power_threshold
                name: Low Power Threshold

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Start/Stop**: Sends command to Kia servers. May take 1-2 minutes.

              **Refresh**: Force data refresh. Use sparingly (rate limits).

              **AC/DC Limits**: Max % the car will charge to.
              - Set AC to 80% for daily use (better battery longevity)
              - Set DC to 80% to avoid slow taper charging

              **Expected Power**: Your charger's typical output. Used for low power alerts.

              **What it WON'T do**: Won't override vehicle safety limits.
              </details>

      # ============================================================
      # ALERTS & SAFETY CARD (DSH-25)
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Alerts & Safety"

          - type: entities
            title: Charging Alerts
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_notify_charging_complete
                name: Charging Complete
              - entity: input_boolean.ev9_notify_charging_interrupted
                name: Charging Interrupted
              - entity: input_number.ev9_charge_interrupt_check_delay
                name: Interrupt Check Delay
              - entity: input_boolean.ev9_notify_low_charging_power
                name: Low Charging Power
              - entity: input_boolean.ev9_overnight_charge_monitor
                name: Overnight Monitor

          - type: entities
            title: Battery Alerts
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_notify_low_battery
                name: Low Battery Alert
              - entity: input_number.ev9_low_battery_threshold
                name: Low Battery Threshold

          - type: entities
            title: Security Alerts
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_notify_unlocked_at_home
                name: Unlocked at Home
              - entity: input_number.ev9_unlocked_alert_delay
                name: Unlocked Alert Delay
              - entity: input_boolean.ev9_notify_trunk_open
                name: Trunk Left Open
              - entity: input_number.ev9_trunk_open_delay
                name: Trunk Alert Delay

          - type: entities
            title: Window Alert
            show_header_toggle: false
            entities:
              - entity: input_boolean.ev9_auto_close_windows_enabled
                name: Window Open Alert
              - entity: input_number.ev9_auto_close_windows_delay
                name: Alert Delay

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              **Charging Complete** (AUT-01): Notifies when charge finishes while plugged in.

              **Charging Interrupted** (AUT-11): Alerts if charging stops unexpectedly overnight (8PM-7AM).

              **Low Charging Power** (AUT-12): Alerts if power drops below threshold while under 80% SOC.

              **Low Battery** (AUT-02): Alerts when battery drops below threshold and not charging.

              **Unlocked at Home** (AUT-03): Informational alert, does NOT auto-lock.

              **Trunk Left Open**: Alerts after configured delay.

              **Window Open Alert**: Renamed from "Auto-Close Windows". Alerts when leaving home with windows open.

              **Severity levels**:
              - Informational: Charging complete, unlocked at home
              - Urgent: Charging interrupted, low battery, trunk open
              </details>

      # ============================================================
      # AUTOMATION HEALTH CARD (DSH-26)
      # ============================================================
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Automation Health"

          - type: entities
            show_header_toggle: false
            entities:
              - entity: input_text.ev9_last_walkaway_result
                name: Last Walk-Away Lock
              - entity: input_text.ev9_last_timeout_lock_result
                name: Last Timeout Lock
              - entity: input_text.ev9_last_precondition_result
                name: Last Precondition

          - type: markdown
            content: |
              <details>
              <summary><b>Logic & Info</b></summary>

              Shows the last execution result for key automations.

              Format: `HH:MM - STATUS: Details`

              **Statuses**:
              - SUCCESS: Action completed
              - SKIPPED: Conditions not met
              - FAILED: Error occurred

              *Full event history is in the Logs tab.*
              </details>

  # ============================================================
  # VIEW 3: LOGS (Read-only Event History - DSH-19)
  # ============================================================
  - title: Logs
    path: logs
    icon: mdi:text-box-multiple-outline
    cards:

      # ============================================================
      # LAST RUN SUMMARY
      # ============================================================
      - type: markdown
        title: Last Run Summary
        content: |
          **Walk-Away Lock**: {{ states('input_text.ev9_last_walkaway_result') or 'No events yet' }}

          **Timeout Lock**: {{ states('input_text.ev9_last_timeout_lock_result') or 'No events yet' }}

          **Precondition**: {{ states('input_text.ev9_last_precondition_result') or 'No events yet' }}

      # ============================================================
      # RECENT EVENTS (10 most recent)
      # ============================================================
      - type: markdown
        title: Recent Events
        content: |
          {% set events = [
            states('input_text.ev9_event_1'),
            states('input_text.ev9_event_2'),
            states('input_text.ev9_event_3'),
            states('input_text.ev9_event_4'),
            states('input_text.ev9_event_5'),
            states('input_text.ev9_event_6'),
            states('input_text.ev9_event_7'),
            states('input_text.ev9_event_8'),
            states('input_text.ev9_event_9'),
            states('input_text.ev9_event_10')
          ] %}
          {% set filtered = events | reject('eq', '') | reject('eq', 'unknown') | reject('eq', 'unavailable') | list %}
          {% if filtered | length == 0 %}
          *No events logged yet.*
          {% else %}
          {% for event in filtered %}
          - {{ event }}
          {% endfor %}
          {% endif %}

      # ============================================================
      # CLEAR LOG BUTTON
      # ============================================================
      - type: custom:button-card
        name: Clear Event Log
        icon: mdi:delete-outline
        tap_action:
          action: call-service
          service: script.ev9_clear_event_log
          confirmation:
            text: "Clear all event log entries?"
        styles:
          card:
            - background-color: var(--error-color)
            - color: white
          icon:
            - color: white

      # ============================================================
      # LOG INFO
      # ============================================================
      - type: markdown
        content: |
          <details>
          <summary><b>Logic & Info</b></summary>

          **Event log format**: `HH:MM - EVENT_TYPE: Details`

          **Event types**:
          - CHARGING_COMPLETE, LOW_BATTERY, CHARGING_INTERRUPTED
          - LOW_POWER, WALKAWAY_LOCK, TIMEOUT_LOCK
          - PRECONDITION, CLIMATE_START, CLIMATE_STOP
          - MANUAL_LOCK, PLUG_DETECTED, FORCE_UPDATE
          - TRUNK_OPEN, AUTO_CLOSE_WINDOWS, UNLOCKED_ALERT

          **Rolling log**: Newest events at top, oldest pushed out after 10 entries.

          **Clear Log**: Removes all entries. Use to reset after testing.

          *Events are logged by automations via `python_script.shift_event_log`.*
          </details>
