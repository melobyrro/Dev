# packages/claude_config_auditor/claude_config_auditor.yaml
# ============================================
# CLAUDE CONFIG AUDITOR PACKAGE
# ============================================
# Purpose: Monitor Claude Code configuration files across projects
#          and surface actionable recommendations via dashboard
# Version: 1.1
# Last Updated: 2026-01-25
# ============================================

# ============================================
# REST SENSORS (Poll n8n Status API)
# ============================================

rest:
  - resource: "http://192.168.1.11:5678/webhook/status-api"
    scan_interval: 300  # 5 minutes
    timeout: 30
    sensor:
      - name: "Claude Config Audit Raw"
        unique_id: claude_config_audit_raw
        value_template: "{{ value_json.status | default('unknown') }}"
        json_attributes:
          - projects
          - total_projects
          - total_files_discovered
          - total_commands
          - total_skills
          - critical_count
          - error_count
          - warning_count
          - info_count
          - health_score
          - last_sync
          - recommendation_states

# ============================================
# TEMPLATE SENSORS
# ============================================

template:
  - sensor:
      - name: "Claude Config Audit Status"
        unique_id: claude_config_audit_status
        icon: >
          {% set status = states('sensor.claude_config_audit_raw') %}
          {% if status == 'critical' %}
            mdi:alert-circle
          {% elif status == 'error' %}
            mdi:alert
          {% elif status == 'warning' %}
            mdi:alert-outline
          {% elif status == 'healthy' %}
            mdi:check-circle
          {% else %}
            mdi:help-circle-outline
          {% endif %}
        state: "{{ states('sensor.claude_config_audit_raw') }}"

      - name: "Claude Config Projects Count"
        unique_id: claude_config_projects_count
        icon: mdi:folder-multiple
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'total_projects') | default(0) }}"

      - name: "Claude Config Health Score"
        unique_id: claude_config_health_score
        icon: mdi:gauge
        unit_of_measurement: "%"
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'health_score') | default(0) }}"

      - name: "Claude Config Critical Count"
        unique_id: claude_config_critical_count
        icon: mdi:alert-circle
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'critical_count') | default(0) }}"

      - name: "Claude Config Error Count"
        unique_id: claude_config_error_count
        icon: mdi:alert
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'error_count') | default(0) }}"

      - name: "Claude Config Warning Count"
        unique_id: claude_config_warning_count
        icon: mdi:alert-outline
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'warning_count') | default(0) }}"

      - name: "Claude Config Info Count"
        unique_id: claude_config_info_count
        icon: mdi:information
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'info_count') | default(0) }}"

      - name: "Claude Config Files Discovered"
        unique_id: claude_config_files_discovered
        icon: mdi:file-document-multiple
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'total_files_discovered') | default(0) }}"

      - name: "Claude Config Commands Count"
        unique_id: claude_config_commands_count
        icon: mdi:console
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'total_commands') | default(0) }}"

      - name: "Claude Config Skills Count"
        unique_id: claude_config_skills_count
        icon: mdi:robot
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'total_skills') | default(0) }}"

      - name: "Claude Config Commands List"
        unique_id: claude_config_commands_list
        icon: mdi:console
        state: >
          {% set projects = state_attr('sensor.claude_config_audit_raw', 'projects') %}
          {% if projects and projects[0] and projects[0].commands %}
            {{ projects[0].commands | join(', ') }}
          {% else %}
            none
          {% endif %}

      - name: "Claude Config Skills List"
        unique_id: claude_config_skills_list
        icon: mdi:robot
        state: >
          {% set projects = state_attr('sensor.claude_config_audit_raw', 'projects') %}
          {% if projects and projects[0] and projects[0].skills %}
            {{ projects[0].skills | join(', ') }}
          {% else %}
            none
          {% endif %}

      - name: "Claude Config Last Sync"
        unique_id: claude_config_last_sync
        icon: mdi:clock-outline
        device_class: timestamp
        state: >
          {% set last_sync = state_attr('sensor.claude_config_audit_raw', 'last_sync') %}
          {% if last_sync %}
            {{ last_sync }}
          {% else %}
            unknown
          {% endif %}

      - name: "Claude Config Pending Candidates"
        unique_id: claude_config_pending_candidates
        icon: mdi:lightbulb-outline
        state: "{{ state_attr('sensor.claude_config_audit_raw', 'pending_candidates') | default(0) }}"

      - name: "Claude Recommendation Status"
        unique_id: claude_recommendation_status
        icon: mdi:lightbulb-on
        state: >
          {% set recommendations = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
          {% if recommendations %}
            {{ recommendations.values() | selectattr('state', 'equalto', 'open') | list | length }} active
          {% else %}
            5 active
          {% endif %}
        attributes:
          total_recommendations: 5
          active: >
            {% set recommendations = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if recommendations %}
              {{ recommendations.values() | selectattr('state', 'equalto', 'open') | list | length }}
            {% else %}
              5
            {% endif %}
          dismissed: >
            {% set recommendations = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if recommendations %}
              {{ recommendations.values() | selectattr('state', 'equalto', 'dismissed') | list | length }}
            {% else %}
              0
            {% endif %}
          reminded: >
            {% set recommendations = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if recommendations %}
              {{ recommendations.values() | selectattr('state', 'equalto', 'reminded') | list | length }}
            {% else %}
              0
            {% endif %}
          completed: >
            {% set recommendations = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if recommendations %}
              {{ recommendations.values() | selectattr('state', 'equalto', 'completed') | list | length }}
            {% else %}
              0
            {% endif %}

      - name: "Claude Config Audit Age"
        unique_id: claude_config_audit_age
        icon: mdi:timer-sand
        unit_of_measurement: "h"
        state: >
          {% set last_sync = state_attr('sensor.claude_config_audit_raw', 'last_sync') %}
          {% if last_sync %}
            {% set age_seconds = (now().timestamp() - as_timestamp(last_sync)) %}
            {{ (age_seconds / 3600) | round(1) }}
          {% else %}
            999
          {% endif %}

      # Individual Recommendation Sensors
      - name: "Claude Recommendation SessionStart Hooks"
        unique_id: claude_recommendation_sessionstart_hooks
        icon: mdi:hook
        state: >
          {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
          {% if rec_states and 'sessionstart-hooks' in rec_states %}
            {{ rec_states['sessionstart-hooks'].state }}
          {% else %}
            open
          {% endif %}
        attributes:
          feature_name: "SessionStart Hooks"
          category: "Automation"
          dismissed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'sessionstart-hooks' in rec_states %}
              {{ rec_states['sessionstart-hooks'].dismissed_at }}
            {% endif %}
          reminded_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'sessionstart-hooks' in rec_states %}
              {{ rec_states['sessionstart-hooks'].reminded_at }}
            {% endif %}
          completed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'sessionstart-hooks' in rec_states %}
              {{ rec_states['sessionstart-hooks'].completed_at }}
            {% endif %}

      - name: "Claude Recommendation GitHub MCP"
        unique_id: claude_recommendation_github_mcp
        icon: mdi:github
        state: >
          {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
          {% if rec_states and 'github-mcp' in rec_states %}
            {{ rec_states['github-mcp'].state }}
          {% else %}
            open
          {% endif %}
        attributes:
          feature_name: "GitHub MCP Server"
          category: "Integration"
          dismissed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'github-mcp' in rec_states %}
              {{ rec_states['github-mcp'].dismissed_at }}
            {% endif %}
          reminded_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'github-mcp' in rec_states %}
              {{ rec_states['github-mcp'].reminded_at }}
            {% endif %}
          completed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'github-mcp' in rec_states %}
              {{ rec_states['github-mcp'].completed_at }}
            {% endif %}

      - name: "Claude Recommendation Tool Search"
        unique_id: claude_recommendation_tool_search
        icon: mdi:magnify
        state: >
          {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
          {% if rec_states and 'tool-search' in rec_states %}
            {{ rec_states['tool-search'].state }}
          {% else %}
            open
          {% endif %}
        attributes:
          feature_name: "MCP Tool Search"
          category: "Performance"
          dismissed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'tool-search' in rec_states %}
              {{ rec_states['tool-search'].dismissed_at }}
            {% endif %}
          reminded_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'tool-search' in rec_states %}
              {{ rec_states['tool-search'].reminded_at }}
            {% endif %}
          completed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'tool-search' in rec_states %}
              {{ rec_states['tool-search'].completed_at }}
            {% endif %}

      - name: "Claude Recommendation Deny Rules"
        unique_id: claude_recommendation_deny_rules
        icon: mdi:shield-lock
        state: >
          {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
          {% if rec_states and 'deny-rules' in rec_states %}
            {{ rec_states['deny-rules'].state }}
          {% else %}
            open
          {% endif %}
        attributes:
          feature_name: "Permission Deny Rules"
          category: "Security"
          dismissed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'deny-rules' in rec_states %}
              {{ rec_states['deny-rules'].dismissed_at }}
            {% endif %}
          reminded_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'deny-rules' in rec_states %}
              {{ rec_states['deny-rules'].reminded_at }}
            {% endif %}
          completed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'deny-rules' in rec_states %}
              {{ rec_states['deny-rules'].completed_at }}
            {% endif %}

      - name: "Claude Recommendation Manual Skills"
        unique_id: claude_recommendation_manual_skills
        icon: mdi:hand-back-left
        state: >
          {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
          {% if rec_states and 'disable-model-invocation' in rec_states %}
            {{ rec_states['disable-model-invocation'].state }}
          {% else %}
            open
          {% endif %}
        attributes:
          feature_name: "Manual-Only Skills"
          category: "Automation"
          dismissed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'disable-model-invocation' in rec_states %}
              {{ rec_states['disable-model-invocation'].dismissed_at }}
            {% endif %}
          reminded_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'disable-model-invocation' in rec_states %}
              {{ rec_states['disable-model-invocation'].reminded_at }}
            {% endif %}
          completed_at: >
            {% set rec_states = state_attr('sensor.claude_config_audit_raw', 'recommendation_states') %}
            {% if rec_states and 'disable-model-invocation' in rec_states %}
              {{ rec_states['disable-model-invocation'].completed_at }}
            {% endif %}

  - binary_sensor:
      - name: "Claude Config Audit Stale"
        unique_id: claude_config_audit_stale
        icon: mdi:clock-alert
        device_class: problem
        state: >
          {% set age = states('sensor.claude_config_audit_age') | float(999) %}
          {{ age > 8 }}

      - name: "Claude Config Has Critical Issues"
        unique_id: claude_config_has_critical
        icon: mdi:alert-circle
        device_class: problem
        state: >
          {% set critical = states('sensor.claude_config_critical_count') | int(0) %}
          {{ critical > 0 }}

# ============================================
# INPUT SELECT (Filter)
# ============================================

input_select:
  claude_recommendation_filter:
    name: "Recommendation Filter"
    options:
      - "All"
      - "Open"
      - "Dismissed"
      - "Reminded"
      - "Completed"
    initial: "All"
    icon: mdi:filter

# ============================================
# INPUT BOOLEANS (Notification Preferences & Detail Toggles)
# ============================================

input_boolean:
  claude_config_notify_critical:
    name: "Claude Config - Notify on Critical"
    icon: mdi:bell-alert
    initial: true

  claude_config_notify_stale:
    name: "Claude Config - Notify on Stale Data"
    icon: mdi:bell-sleep
    initial: true

  # Detail toggle booleans for recommendation cards
  claude_details_sessionstart_hooks:
    name: "Show SessionStart Hooks Details"
    icon: mdi:information
    initial: false

  claude_details_github_mcp:
    name: "Show GitHub MCP Details"
    icon: mdi:information
    initial: false

  claude_details_tool_search:
    name: "Show Tool Search Details"
    icon: mdi:information
    initial: false

  claude_details_deny_rules:
    name: "Show Deny Rules Details"
    icon: mdi:information
    initial: false

  claude_details_manual_skills:
    name: "Show Manual Skills Details"
    icon: mdi:information
    initial: false

# ============================================
# REST COMMANDS - Recommendation Actions
# ============================================

rest_command:
  claude_recommendation_complete:
    url: "http://192.168.1.11:5678/webhook/recommendation-action-ha"
    method: POST
    timeout: 30
    content_type: "application/json"
    payload: '{"recommendation_id": "{{ recommendation_id }}", "action": "complete", "source": "home_assistant"}'

  claude_recommendation_dismiss:
    url: "http://192.168.1.11:5678/webhook/recommendation-action-ha"
    method: POST
    timeout: 30
    content_type: "application/json"
    payload: '{"recommendation_id": "{{ recommendation_id }}", "action": "dismiss", "source": "home_assistant"}'

  claude_recommendation_remind:
    url: "http://192.168.1.11:5678/webhook/recommendation-action-ha"
    method: POST
    timeout: 30
    content_type: "application/json"
    payload: '{"recommendation_id": "{{ recommendation_id }}", "action": "remind", "source": "home_assistant"}'

# ============================================
# SCRIPTS - Recommendation Actions
# ============================================

script:
  # SessionStart Hooks
  complete_sessionstart_hooks:
    alias: "Complete SessionStart Hooks"
    description: "Mark SessionStart Hooks recommendation as completed"
    icon: mdi:check
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_complete
        data:
          recommendation_id: "sessionstart-hooks"

  remind_sessionstart_hooks:
    alias: "Remind SessionStart Hooks"
    description: "Set reminder for SessionStart Hooks recommendation"
    icon: mdi:clock-outline
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_remind
        data:
          recommendation_id: "sessionstart-hooks"

  dismiss_sessionstart_hooks:
    alias: "Dismiss SessionStart Hooks"
    description: "Dismiss SessionStart Hooks recommendation"
    icon: mdi:close
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_dismiss
        data:
          recommendation_id: "sessionstart-hooks"

  # GitHub MCP Server
  complete_github_mcp:
    alias: "Complete GitHub MCP"
    description: "Mark GitHub MCP Server recommendation as completed"
    icon: mdi:check
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_complete
        data:
          recommendation_id: "github-mcp"

  remind_github_mcp:
    alias: "Remind GitHub MCP"
    description: "Set reminder for GitHub MCP Server recommendation"
    icon: mdi:clock-outline
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_remind
        data:
          recommendation_id: "github-mcp"

  dismiss_github_mcp:
    alias: "Dismiss GitHub MCP"
    description: "Dismiss GitHub MCP Server recommendation"
    icon: mdi:close
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_dismiss
        data:
          recommendation_id: "github-mcp"

  # Tool Search
  complete_tool_search:
    alias: "Complete Tool Search"
    description: "Mark Tool Search recommendation as completed"
    icon: mdi:check
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_complete
        data:
          recommendation_id: "tool-search"

  remind_tool_search:
    alias: "Remind Tool Search"
    description: "Set reminder for Tool Search recommendation"
    icon: mdi:clock-outline
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_remind
        data:
          recommendation_id: "tool-search"

  dismiss_tool_search:
    alias: "Dismiss Tool Search"
    description: "Dismiss Tool Search recommendation"
    icon: mdi:close
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_dismiss
        data:
          recommendation_id: "tool-search"

  # Permission Deny Rules
  complete_deny_rules:
    alias: "Complete Deny Rules"
    description: "Mark Permission Deny Rules recommendation as completed"
    icon: mdi:check
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_complete
        data:
          recommendation_id: "deny-rules"

  remind_deny_rules:
    alias: "Remind Deny Rules"
    description: "Set reminder for Permission Deny Rules recommendation"
    icon: mdi:clock-outline
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_remind
        data:
          recommendation_id: "deny-rules"

  dismiss_deny_rules:
    alias: "Dismiss Deny Rules"
    description: "Dismiss Permission Deny Rules recommendation"
    icon: mdi:close
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_dismiss
        data:
          recommendation_id: "deny-rules"

  # Manual-Only Skills
  complete_manual_skills:
    alias: "Complete Manual Skills"
    description: "Mark Manual-Only Skills recommendation as completed"
    icon: mdi:check
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_complete
        data:
          recommendation_id: "disable-model-invocation"

  remind_manual_skills:
    alias: "Remind Manual Skills"
    description: "Set reminder for Manual-Only Skills recommendation"
    icon: mdi:clock-outline
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_remind
        data:
          recommendation_id: "disable-model-invocation"

  dismiss_manual_skills:
    alias: "Dismiss Manual Skills"
    description: "Dismiss Manual-Only Skills recommendation"
    icon: mdi:close
    mode: single
    sequence:
      - service: rest_command.claude_recommendation_dismiss
        data:
          recommendation_id: "disable-model-invocation"

# ============================================
# AUTOMATIONS
# ============================================

automation:
  - id: claude_config_critical_alert
    alias: "Claude Config - Critical Issue Alert"
    description: >
      Send notification when critical security issues are detected
      in Claude Code configuration files.
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.claude_config_has_critical
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.claude_config_notify_critical
        state: "on"
    action:
      - service: notify.mobile_app_iphone
        data:
          title: "Claude Config: Critical Issue"
          message: >
            {{ states('sensor.claude_config_critical_count') }} critical security issue(s) detected.
            Health score: {{ states('sensor.claude_config_health_score') }}%
          data:
            push:
              sound:
                name: default
                critical: 1
                volume: 1.0
            url: "/lovelace/homelab"
            tag: "claude_config_critical"

  - id: claude_config_stale_warning
    alias: "Claude Config - Stale Data Warning"
    description: >
      Send notification when audit data is older than 8 hours.
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.claude_config_audit_stale
        to: "on"
        for:
          minutes: 30
    condition:
      - condition: state
        entity_id: input_boolean.claude_config_notify_stale
        state: "on"
    action:
      - service: notify.mobile_app_iphone
        data:
          title: "Claude Config: Stale Audit"
          message: >
            Config audit data is {{ states('sensor.claude_config_audit_age') }} hours old.
            Last sync: {{ states('sensor.claude_config_last_sync') }}
          data:
            url: "/lovelace/homelab"
            tag: "claude_config_stale"

  - id: claude_config_resolved_notification
    alias: "Claude Config - Issues Resolved"
    description: >
      Send notification when critical issues are resolved.
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.claude_config_has_critical
        from: "on"
        to: "off"
    condition:
      - condition: state
        entity_id: input_boolean.claude_config_notify_critical
        state: "on"
    action:
      - service: notify.mobile_app_iphone
        data:
          title: "Claude Config: Issues Resolved"
          message: >
            All critical issues resolved. Health score: {{ states('sensor.claude_config_health_score') }}%
          data:
            url: "/lovelace/homelab"
            tag: "claude_config_resolved"
