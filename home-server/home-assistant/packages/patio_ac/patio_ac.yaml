# packages/patio_ac/patio_ac.yaml
# ============================================
# PATIO AC CONTROL SYSTEM PACKAGE
# ============================================
# Purpose: Complete patio mini-split AC automation system
# Migrated from: 
#   - automations.v2.11.yaml
#   - configuration.v2.9.yaml
#   - scripts.v2.8.yaml
# Last Updated: 2026-01-22
# ============================================

# ============================================
# CONFIGURATION (Helpers & Sensors)
# Migrated from configuration.v2.9.yaml
# ============================================

input_boolean:
  patio_ac_show_explain_global:
    name: "Show Global Config Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_show_explain_heat_guard:
    name: "Show Heat Guard Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_manual_override:
    name: "Patio AC Manual Override"
    icon: mdi:hand-back-right
    initial: off
  patio_ac_compressor_cooldown:
    name: "Patio AC Compressor Cooldown Active"
    initial: off
    icon: mdi:snowflake-alert
  patio_ac_humidity_emergency_only:
    name: "Patio AC Emergency-Only Mode"
    initial: off
    icon: mdi:water-alert
  patio_ac_heat_guard_enabled:
    name: "Heat Guard Enabled"
    initial: on
    icon: mdi:fire
  patio_ac_day_humidity_enabled:
    name: "Day Humidity Enabled"
    initial: on
    icon: mdi:water-check
  patio_ac_night_humidity_enabled:
    name: "Night Humidity Enabled"
    initial: on
    icon: mdi:weather-night
  patio_ac_show_guide_heat:
    name: Show Heat Guide
    initial: off
    icon: mdi:help-circle
  patio_ac_show_guide_day:
    name: Show Day Guide
    initial: off
    icon: mdi:help-circle
  patio_ac_show_guide_night:
    name: Show Night Guide
    initial: off
    icon: mdi:help-circle
  patio_ac_show_guide_safety:
    name: Show Safety Guide
    initial: off
    icon: mdi:help-circle
  patio_ac_show_explain_dew_point:
    name: "Show Dew Point Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_show_explain_status:
    name: "Show Automation Status Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_show_explain_runtime:
    name: "Show Runtime & Limits Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_show_explain_protections:
    name: "Show Protections & Timers Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_show_explain_day_rules:
    name: "Show Day Humidity Rules Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_show_explain_night_rules:
    name: "Show Night Humidity Rules Explanation"
    initial: off
    icon: mdi:help-circle-outline
  patio_ac_allow_seamless_handoff:
    name: "Patio AC Allow Seamless Handoff"
    icon: mdi:handshake
    initial: off

input_button:
  patio_ac_resume_automation:
    name: "Patio AC - Resume Automation"
    icon: mdi:refresh
  patio_ac_activity_clear:
    name: "Patio AC - Clear Activity"
    icon: mdi:broom

input_number:
  patio_ac_daily_limit:
    name: "Patio AC Automation Cap (minutes)"
    min: 0
    max: 1440
    step: 30
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:timer-lock
  patio_ac_compressor_cooldown_minutes:
    name: "Compressor Cooldown (minutes)"
    min: 0
    max: 30
    step: 1
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:snowflake-alert
  patio_ac_default_dry_temp:
    name: "Default DRY Setpoint (°F)"
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
    mode: slider
    icon: mdi:thermostat
  patio_ac_heat_duration:
    name: "Heat Guard Max Duration (minutes)"
    min: 0
    max: 1440
    step: 30
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:timer
  patio_ac_daily_runtime:
    name: "Patio AC Daily Runtime (minutes)"
    min: 0
    max: 1440
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:timer-sand
  patio_ac_humidity_runtime:
    name: "Patio AC Humidity Runtime (minutes)"
    min: 0
    max: 1440
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: mdi:timer-sand
  patio_ac_humidity_soft_cap:
    name: "Patio AC Humidity Soft Cap (minutes)"
    min: 0
    max: 600
    step: 15
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:timer-sand-complete
  patio_ac_heat_threshold:
    name: "Heat Guard Threshold"
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
    mode: slider
    icon: mdi:thermometer-alert
  patio_ac_heat_target:
    name: "Heat Guard Target Temp"
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
    mode: slider
    icon: mdi:thermometer-check
  patio_ac_dewpoint_start:
    name: "Dew Point Start Threshold"
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
    mode: slider
    icon: mdi:water-thermometer
  patio_ac_dewpoint_night_start:
    name: "Night Dew Point Start"
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
    mode: slider
    icon: mdi:water-thermometer
  patio_ac_dewpoint_stop:
    name: "Dew Point Stop Threshold"
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
    mode: slider
    icon: mdi:water-check
  patio_ac_rh_night_start:
    name: "Night RH Start Threshold"
    min: 60
    max: 80
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
  patio_ac_rh_night_stop:
    name: "Night RH Stop Threshold"
    min: 55
    max: 70
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-check
  patio_ac_rh_day_start:
    name: "Day RH Start Threshold"
    min: 65
    max: 85
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:weather-sunny
  patio_ac_rh_day_stop:
    name: "Day RH Stop Threshold"
    min: 55
    max: 70
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:weather-sunny-alert
  patio_ac_rh_emergency:
    name: "RH Emergency Ceiling"
    min: 70
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:alarm-light
  patio_ac_humidity_min_on:
    name: "Humidity Min ON (minutes)"
    min: 15
    max: 90
    step: 5
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:timer-outline
  patio_ac_humidity_min_off:
    name: "Humidity Min OFF (minutes)"
    min: 15
    max: 120
    step: 5
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:timer-lock-open
  patio_ac_manual_timeout:
    name: "Manual Override Timeout"
    min: 30
    max: 360
    step: 30
    unit_of_measurement: "min"
    mode: slider
    icon: mdi:timer-off
  patio_ac_min_meaningful_run_minutes:
    name: Minimum Meaningful Run Time
    min: 5
    max: 30
    step: 5
    unit_of_measurement: min
    mode: slider
    icon: mdi:timer-cog
  patio_ac_poll_settle_seconds:
    name: Poll Settle Time
    min: 2
    max: 10
    step: 1
    unit_of_measurement: s
    mode: slider
    icon: mdi:timer-sync
  patio_ac_dewpoint_day_stop:
    name: Day Dew Point Stop
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"
  patio_ac_dewpoint_night_stop:
    name: Night Dew Point Stop
    min: 45
    max: 100
    step: 1
    unit_of_measurement: "°F"

input_select:
  patio_ac_reason:
    name: "Patio AC Active Reason"
    options:
      - idle
      - heat_guard
      - humidity_night
      - humidity_day
      - humidity_emergency
      - manual
      - safety_lock
    initial: idle
    icon: mdi:state-machine

input_text:
  patio_ac_expected_signature:
    name: "Patio AC Expected Signature"
    max: 255
    icon: mdi:signature
  patio_ac_event_1:
    name: "Patio AC Event 1"
    max: 255
    initial: ""
  patio_ac_event_2:
    name: "Patio AC Event 2"
    max: 255
    initial: ""
  patio_ac_event_3:
    name: "Patio AC Event 3"
    max: 255
    initial: ""
  patio_ac_event_4:
    name: "Patio AC Event 4"
    max: 255
    initial: ""
  patio_ac_event_5:
    name: "Patio AC Event 5"
    max: 255
    initial: ""
  patio_ac_event_6:
    name: "Patio AC Event 6"
    max: 255
    initial: ""
  patio_ac_event_7:
    name: "Patio AC Event 7"
    max: 255
    initial: ""
  patio_ac_event_8:
    name: "Patio AC Event 8"
    max: 255
    initial: ""
  patio_ac_event_9:
    name: "Patio AC Event 9"
    max: 255
    initial: ""
  patio_ac_event_10:
    name: "Patio AC Event 10"
    max: 255
    initial: ""

input_datetime:
  patio_ac_expecting_change_until:
    name: "Patio AC Expecting Change Until"
    has_date: true
    has_time: true
  patio_ac_manual_until:
    name: "Patio AC Manual Override Until"
    has_date: true
    has_time: true
  patio_ac_compressor_protection_until:
    name: "Patio AC Compressor Protection Until"
    has_date: true
    has_time: true
  patio_ac_humidity_min_on_until:
    name: "Patio AC Humidity Min ON Until"
    has_date: true
    has_time: true
  patio_ac_humidity_min_off_until:
    name: "Patio AC Humidity Min OFF Until"
    has_date: true
    has_time: true
  patio_ac_heat_spike_until:
    name: "Patio AC Heat Spike Until"
    has_date: true
    has_time: true
  patio_ac_command_throttle_until:
    name: "Patio AC Command Throttle Until"
    has_date: true
    has_time: true
  patio_ac_day_start:
    name: "Patio AC Day Start"
    has_date: false
    has_time: true
  patio_ac_night_start:
    name: "Patio AC Night Start"
    has_date: false
    has_time: true
  patio_ac_last_command:
    name: "Patio AC Last Command Time"
    has_date: true
    has_time: true
  patio_ac_last_off:
    name: "Patio AC Last OFF Time"
    has_date: true
    has_time: true
  patio_ac_runtime_start:
    name: "Patio AC Runtime Start"
    has_date: true
    has_time: true

timer:
  patio_ac_heat_spike:
    name: "Patio AC Heat Spike Timer"
    restore: true
  patio_ac_manual_override:
    name: "Patio AC Manual Override Timer"
    restore: true
  patio_ac_compressor_protection:
    name: "Patio AC Compressor Protection Timer"
    duration: "00:10:00"
    restore: true
  patio_ac_command_throttle:
    name: "Patio AC Command Throttle Timer"
    duration: "00:03:00"
    restore: true
  patio_ac_manual_safety:
    name: "Patio AC Manual Safety Timer"
    duration: "08:00:00"
    restore: true
  patio_ac_humidity_min_on:
    name: "Patio AC Humidity Min ON"
    duration: "00:35:00"
    restore: true
  patio_ac_humidity_min_off:
    name: "Patio AC Humidity Min OFF"
    duration: "00:45:00"
    restore: true

template:
  - binary_sensor:
      - name: "Patio AC Automation Cool Running"
        unique_id: patio_ac_automation_cool_running
        state: >
          {{ states('climate.patio_ac') == 'cool' and
             states('input_select.patio_ac_reason') == 'heat_guard' }}
      - name: "Patio AC Automation Dry Running"
        unique_id: patio_ac_automation_dry_running
        state: >
          {{ states('climate.patio_ac') == 'dry' and
             states('input_select.patio_ac_reason') in ['humidity_day', 'humidity_night'] }}
      - name: "Patio AC Manual Cool Running"
        unique_id: patio_ac_manual_cool_running
        state: >
          {{ states('climate.patio_ac') == 'cool' and
             states('input_select.patio_ac_reason') == 'manual' }}
      - name: "Patio AC Manual Dry Running"
        unique_id: patio_ac_manual_dry_running
        state: >
          {{ states('climate.patio_ac') == 'dry' and
             states('input_select.patio_ac_reason') == 'manual' }}
      - name: "Patio AC Running"
        unique_id: patio_ac_running
        device_class: power
        state: >
          {% set hvac = states('climate.patio_ac') %}
          {{ hvac not in ['off', 'unavailable', 'unknown'] }}
      - name: "Patio AC Mode Cool"
        unique_id: patio_ac_mode_cool
        state: >
          {{ states('climate.patio_ac') == 'cool' }}
      - name: "Patio AC Mode Dry"
        unique_id: patio_ac_mode_dry
        state: >
          {{ states('climate.patio_ac') == 'dry' }}

  - trigger:
      - platform: time_pattern
        seconds: "/1"
    sensor:
      - name: "Patio AC Next Evaluation"
        unique_id: patio_ac_next_evaluation
        icon: mdi:timer-sand
        state: >
          {% set last = state_attr('automation.patio_ac_evaluation_logic', 'last_triggered') %}
          {% set last_ts = as_timestamp(last) if last else as_timestamp(now()) %}
          {% set next_ts = last_ts + 300 %}
          {% set remaining = (next_ts - as_timestamp(now())) | int(0) %}
          {% set remaining = [remaining, 0] | max %}
          {% set mins = remaining // 60 %}
          {% set secs = remaining % 60 %}
          {{ '%02d:%02d' | format(mins, secs) }}
      - name: "Patio AC Compressor Wait Time"
        unique_id: patio_ac_compressor_wait
        icon: mdi:timer-outline
        state: >
          {% set until = as_timestamp(states('input_datetime.patio_ac_compressor_protection_until'), 0) %}
          {% set remaining = (until - as_timestamp(now())) | int(0) %}
          {% set remaining = [remaining, 0] | max %}
          {% set mins = remaining // 60 %}
          {% set secs = remaining % 60 %}
          {{ '%02d:%02d' | format(mins, secs) }}

  - sensor:
      - name: "Patio AC Last Evaluated"
        unique_id: patio_ac_last_evaluated
        icon: mdi:clock-check-outline
        state: >
          {% set last = state_attr('automation.patio_ac_evaluation_logic', 'last_triggered') %}
          {% if last %}
            {{ as_local(as_datetime(last)).strftime('%H:%M:%S') }}
          {% else %}
            {{ now().strftime('%H:%M:%S') }}
          {% endif %}

      - name: "Patio AC Reason Friendly"
        unique_id: patio_ac_reason_friendly
        icon: mdi:information-outline
        state: >
          {% set reason = states('input_select.patio_ac_reason') %}
          {% set mapping = {
            'idle': 'Idle',
            'manual': 'Manual',
            'heat_guard': 'Heat Guard',
            'humidity_day': 'Day Humidity',
            'humidity_night': 'Night Humidity',
            'humidity_emergency': 'Safety/Emergency',
            'safety_lock': 'Safety/Emergency'
          } %}
          {{ mapping.get(reason, reason | replace('_', ' ') | title) }}

      - name: "Patio AC Automation Cap Display"
        unique_id: patio_ac_daily_limit_display
        icon: mdi:timer-lock
        state: >
          {% set minutes = states('input_number.patio_ac_daily_limit') | int(0) %}
          {% set hours = minutes // 60 %}
          {% set mins = minutes % 60 %}
          {{ hours }}h {{ '%02d' | format(mins) }}m

      - name: "Patio AC Heat Duration Display"
        unique_id: patio_ac_heat_duration_display
        icon: mdi:timer
        state: >
          {% set minutes = states('input_number.patio_ac_heat_duration') | int(0) %}
          {% set hours = minutes // 60 %}
          {% set mins = minutes % 60 %}
          {{ hours }}h {{ '%02d' | format(mins) }}m

      - name: "Patio AC Override State"
        unique_id: patio_ac_override_state
        icon: mdi:lock-outline
        state: >
          {% set reason = states('input_select.patio_ac_reason') %}
          {% set mapping = {
            'idle': 'Idle',
            'manual': 'Manual',
            'heat_guard': 'Heat Guard',
            'humidity_day': 'Day Humidity',
            'humidity_night': 'Night Humidity',
            'humidity_emergency': 'Emergency RH Stop',
            'safety_lock': 'Safety Lock'
          } %}
          {{ mapping.get(reason, reason | replace('_', ' ') | title) }}

      - name: "Patio AC Mode Numeric"
        unique_id: patio_ac_mode_numeric
        icon: mdi:numeric
        state: >
          {% set mode = states('climate.patio_ac') %}
          {% if mode == 'cool' %}
            1
          {% elif mode == 'dry' %}
            2
          {% else %}
            0
          {% endif %}

      - name: "Patio AC Automation Total Runtime"
        unique_id: patio_ac_automation_total_runtime
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set cool = states('sensor.patio_ac_automation_cool_runtime') | float(0) %}
          {% set dry = states('sensor.patio_ac_automation_dry_runtime') | float(0) %}
          {{ (cool + dry) | round(2) }}

      - name: "Patio AC Manual Total Runtime"
        unique_id: patio_ac_manual_total_runtime
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set cool = states('sensor.patio_ac_manual_cool_runtime') | float(0) %}
          {% set dry = states('sensor.patio_ac_manual_dry_runtime') | float(0) %}
          {{ (cool + dry) | round(2) }}

      - name: "Patio AC Total Runtime"
        unique_id: patio_ac_total_runtime
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set auto = states('sensor.patio_ac_automation_total_runtime') | float(0) %}
          {% set manual = states('sensor.patio_ac_manual_total_runtime') | float(0) %}
          {{ (auto + manual) | round(2) }}

      - name: "Patio AC Total Cool Runtime"
        unique_id: patio_ac_total_cool_runtime
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set auto = states('sensor.patio_ac_automation_cool_runtime') | float(0) %}
          {% set manual = states('sensor.patio_ac_manual_cool_runtime') | float(0) %}
          {{ (auto + manual) | round(2) }}

      - name: "Patio AC Total Dry Runtime"
        unique_id: patio_ac_total_dry_runtime
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set auto = states('sensor.patio_ac_automation_dry_runtime') | float(0) %}
          {% set manual = states('sensor.patio_ac_manual_dry_runtime') | float(0) %}
          {{ (auto + manual) | round(2) }}

      - name: "Patio AC Runtime Cool Automation"
        unique_id: patio_ac_runtime_cool_automation
        unit_of_measurement: "h"
        device_class: duration
        state: "{{ states('sensor.patio_ac_automation_cool_runtime') | float(0) | round(2) }}"

      - name: "Patio AC Runtime Dry Automation"
        unique_id: patio_ac_runtime_dry_automation
        unit_of_measurement: "h"
        device_class: duration
        state: "{{ states('sensor.patio_ac_automation_dry_runtime') | float(0) | round(2) }}"

      - name: "Patio AC Runtime Total Automation"
        unique_id: patio_ac_runtime_total_automation
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set cool = states('sensor.patio_ac_runtime_cool_automation') | float(0) %}
          {% set dry = states('sensor.patio_ac_runtime_dry_automation') | float(0) %}
          {{ (cool + dry) | round(2) }}

      - name: "Patio AC Runtime Cool Manual"
        unique_id: patio_ac_runtime_cool_manual
        unit_of_measurement: "h"
        device_class: duration
        state: "{{ states('sensor.patio_ac_manual_cool_runtime') | float(0) | round(2) }}"

      - name: "Patio AC Runtime Dry Manual"
        unique_id: patio_ac_runtime_dry_manual
        unit_of_measurement: "h"
        device_class: duration
        state: "{{ states('sensor.patio_ac_manual_dry_runtime') | float(0) | round(2) }}"

      - name: "Patio AC Runtime Total Manual"
        unique_id: patio_ac_runtime_total_manual
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set cool = states('sensor.patio_ac_runtime_cool_manual') | float(0) %}
          {% set dry = states('sensor.patio_ac_runtime_dry_manual') | float(0) %}
          {{ (cool + dry) | round(2) }}

      - name: "Patio AC Runtime Total All"
        unique_id: patio_ac_runtime_total_all
        unit_of_measurement: "h"
        device_class: duration
        state: >
          {% set auto = states('sensor.patio_ac_runtime_total_automation') | float(0) %}
          {% set manual = states('sensor.patio_ac_runtime_total_manual') | float(0) %}
          {{ (auto + manual) | round(2) }}

      - name: "Patio AC Runtime Cool Total"
        unique_id: patio_ac_runtime_cool_total
        unit_of_measurement: "h"
        device_class: duration
        state: "{{ states('sensor.patio_ac_total_cool_runtime') | float(0) | round(2) }}"

      - name: "Patio AC Runtime Dry Total"
        unique_id: patio_ac_runtime_dry_total
        unit_of_measurement: "h"
        device_class: duration
        state: "{{ states('sensor.patio_ac_total_dry_runtime') | float(0) | round(2) }}"

      - name: "Patio AC Daily Runtime Display"
        unique_id: patio_ac_daily_runtime_display
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        state: "{{ states('input_number.patio_ac_daily_runtime') | float(0) | round(0) }}"

      - name: "Patio AC Humidity Runtime Display"
        unique_id: patio_ac_humidity_runtime_display
        unit_of_measurement: "min"
        icon: mdi:water-percent
        state: "{{ states('input_number.patio_ac_humidity_runtime') | float(0) | round(0) }}"

sensor:
  - platform: history_stats
    name: "Patio AC Automation Cool Runtime"
    entity_id: binary_sensor.patio_ac_automation_cool_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Patio AC Automation Dry Runtime"
    entity_id: binary_sensor.patio_ac_automation_dry_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Patio AC Manual Cool Runtime"
    entity_id: binary_sensor.patio_ac_manual_cool_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Patio AC Manual Dry Runtime"
    entity_id: binary_sensor.patio_ac_manual_dry_running
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Patio AC Dry Runtime (24h)"
    entity_id: binary_sensor.patio_ac_mode_dry
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Patio AC Cool Runtime (24h)"
    entity_id: binary_sensor.patio_ac_mode_cool
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: statistics
    name: Patio RH 20m Min
    entity_id: sensor.patio_temp_sensor_humidity
    state_characteristic: value_min
    max_age:
      minutes: 20
    keep_last_sample: true
    sampling_size: 120

  - platform: statistics
    name: Patio Dew Point 20m Min
    entity_id: sensor.patio_dew_point
    state_characteristic: value_min
    max_age:
      minutes: 20
    keep_last_sample: true
    sampling_size: 120


python_script:

# ============================================
# UTILITY METER (Energy Tracking)
# ============================================

utility_meter:
  patio_ac_energy_daily:
    source: sensor.150633095083490_total_energy_consumption
    name: "Patio AC Energy Daily"
    cycle: daily
  patio_ac_energy_monthly:
    source: sensor.150633095083490_total_energy_consumption
    name: "Patio AC Energy Monthly"
    cycle: monthly
  patio_ac_energy_yearly:
    source: sensor.150633095083490_total_energy_consumption
    name: "Patio AC Energy Yearly"
    cycle: yearly

# ============================================
# AUTOMATIONS
# Migrated from automations.v2.11.yaml
# ============================================

automation:
- id: patio_ac_heat_guard_on
  alias: "Patio AC - Heat Guard ON"
  description: "Activate cooling when temperature exceeds threshold"
  mode: single
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_temp_sensor_temperature
      above: input_number.patio_ac_heat_threshold
    - platform: time_pattern
      minutes: "/5"
    - platform: state
      entity_id: input_boolean.patio_ac_heat_guard_enabled
      to: "on"
    - platform: state
      entity_id:
        - input_number.patio_ac_heat_threshold
        - input_number.patio_ac_heat_target
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "idle"
    - condition: state
      entity_id: input_boolean.patio_ac_heat_guard_enabled
      state: "on"
    - condition: template
      value_template: >
        {% set auto_hours = states('sensor.patio_ac_runtime_total_automation') | float(0) %}
        {% set auto_minutes = auto_hours * 60 %}
        {{ auto_minutes < states('input_number.patio_ac_daily_limit') | float(0) }}
  action:
    - variables:
        heat_trigger: "{{ states('input_number.patio_ac_heat_threshold') | float(default=none) }}"
        heat_target: "{{ states('input_number.patio_ac_heat_target') | float(default=none) }}"
        heat_invalid: "{{ heat_trigger is none or heat_target is none or heat_target >= heat_trigger }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ heat_invalid }}"
          sequence:
            - action: persistent_notification.create
              data:
                title: "Patio AC Heat Guard"
                message: >
                  Invalid Heat Guard target/trigger configuration. Target must be lower than Trigger.
                notification_id: "patio_ac_heat_guard_invalid_config"
        - conditions:
            - condition: template
              value_template: "{{ not heat_invalid }}"
          sequence:
            - action: persistent_notification.dismiss
              data:
                notification_id: "patio_ac_heat_guard_invalid_config"
            - action: script.patio_ac_control
              data:
                action: "on"
                mode: "cool"
                temperature: "{{ states('input_number.patio_ac_heat_target')|int }}"
                reason: "heat_guard"
                duration: "{{ states('input_number.patio_ac_heat_duration')|int }}"

- id: patio_ac_heat_guard_off
  alias: "Patio AC - Heat Guard OFF (Early Stop)"
  description: "Stop cooling when temperature drops"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_temp_sensor_temperature
      below: input_number.patio_ac_heat_target
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "heat_guard"
  action:
    - action: script.patio_ac_control
      data:
        action: "off"
        reason: "heat_guard"

- id: patio_ac_humidity_night_on
  alias: "Patio AC - Humidity Night ON"
  description: "Start DRY at night based on dew point trigger"
  mode: single
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_dew_point
      above: input_number.patio_ac_dewpoint_night_start
    - platform: time
      at: input_datetime.patio_ac_night_start
    - platform: time_pattern
      minutes: "/5"
    - platform: state
      entity_id: input_boolean.patio_ac_night_humidity_enabled
      to: "on"
    - platform: state
      entity_id:
        - input_number.patio_ac_dewpoint_night_start
        - input_number.patio_ac_dewpoint_night_stop
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "idle"
    - condition: state
      entity_id: input_boolean.patio_ac_night_humidity_enabled
      state: "on"
    - condition: template
      value_template: >
        {% set auto_hours = states('sensor.patio_ac_runtime_total_automation') | float(0) %}
        {% set auto_minutes = auto_hours * 60 %}
        {{ auto_minutes < states('input_number.patio_ac_daily_limit') | float(0) }}
    - condition: time
      after: input_datetime.patio_ac_night_start
      before: input_datetime.patio_ac_day_start
    - condition: template
      value_template: >
        {% set dp = states('sensor.patio_dew_point') | float(default=none) %}
        {% set trigger = states('input_number.patio_ac_dewpoint_night_start') | float(default=none) %}
        {{ dp is not none and trigger is not none and dp >= trigger }}
  action:
    - variables:
        dp_trigger: "{{ states('input_number.patio_ac_dewpoint_night_start') | float(default=none) }}"
        dp_target: "{{ states('input_number.patio_ac_dewpoint_night_stop') | float(default=none) }}"
        dp_invalid: "{{ dp_trigger is none or dp_target is none or dp_target >= dp_trigger }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ dp_invalid }}"
          sequence:
            - action: persistent_notification.create
              data:
                title: "Patio AC Night Humidity"
                message: >
                  Invalid Night Humidity dew point configuration. Target must be lower than Trigger.
                notification_id: "patio_ac_night_humidity_invalid_config"
        - conditions:
            - condition: template
              value_template: "{{ not dp_invalid }}"
          sequence:
            - action: persistent_notification.dismiss
              data:
                notification_id: "patio_ac_night_humidity_invalid_config"
            - action: script.patio_ac_control
              data:
                action: "on"
                mode: "dry"
                temperature: "{{ states('input_number.patio_ac_default_dry_temp') | int }}"
                reason: "humidity_night"

- id: patio_ac_humidity_day_on
  alias: "Patio AC - Humidity Day ON"
  description: "Start DRY during the day based on dew point trigger"
  mode: single
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_dew_point
      above: input_number.patio_ac_dewpoint_start
    - platform: time
      at: input_datetime.patio_ac_day_start
    - platform: time_pattern
      minutes: "/5"
    - platform: state
      entity_id: input_boolean.patio_ac_day_humidity_enabled
      to: "on"
    - platform: state
      entity_id:
        - input_number.patio_ac_dewpoint_start
        - input_number.patio_ac_dewpoint_day_stop
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "idle"
    - condition: state
      entity_id: input_boolean.patio_ac_day_humidity_enabled
      state: "on"
    - condition: template
      value_template: >
        {% set auto_hours = states('sensor.patio_ac_runtime_total_automation') | float(0) %}
        {% set auto_minutes = auto_hours * 60 %}
        {{ auto_minutes < states('input_number.patio_ac_daily_limit') | float(0) }}
    - condition: time
      after: input_datetime.patio_ac_day_start
      before: input_datetime.patio_ac_night_start
    - condition: template
      value_template: >
        {% set dp = states('sensor.patio_dew_point') | float(default=none) %}
        {% set trigger = states('input_number.patio_ac_dewpoint_start') | float(default=none) %}
        {{ dp is not none and trigger is not none and dp >= trigger }}
  action:
    - variables:
        dp_trigger: "{{ states('input_number.patio_ac_dewpoint_start') | float(default=none) }}"
        dp_target: "{{ states('input_number.patio_ac_dewpoint_day_stop') | float(default=none) }}"
        dp_invalid: "{{ dp_trigger is none or dp_target is none or dp_target >= dp_trigger }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ dp_invalid }}"
          sequence:
            - action: persistent_notification.create
              data:
                title: "Patio AC Day Humidity"
                message: >
                  Invalid Day Humidity dew point configuration. Target must be lower than Trigger.
                notification_id: "patio_ac_day_humidity_invalid_config"
        - conditions:
            - condition: template
              value_template: "{{ not dp_invalid }}"
          sequence:
            - action: persistent_notification.dismiss
              data:
                notification_id: "patio_ac_day_humidity_invalid_config"
            - action: script.patio_ac_control
              data:
                action: "on"
                mode: "dry"
                temperature: "{{ states('input_number.patio_ac_default_dry_temp') | int }}"
                reason: "humidity_day"

- id: patio_ac_humidity_emergency_on
  alias: "Patio AC - Emergency RH Stop"
  description: "Emergency stop when RH exceeds ceiling"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_temp_sensor_humidity
      above: input_number.patio_ac_rh_emergency
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states('climate.patio_ac') != 'off' }}"
          sequence:
            - action: script.patio_ac_control
              data:
                action: "off"
                reason: "safety_lock"
    - action: input_select.select_option
      target:
        entity_id: input_select.patio_ac_reason
      data:
        option: "humidity_emergency"
    - action: persistent_notification.create
      data:
        title: "Patio AC Emergency RH Stop"
        message: >
          RH exceeded {{ states('input_number.patio_ac_rh_emergency')|int }}%. AC forced off.
        notification_id: "patio_ac_emergency_rh_stop"

- id: patio_ac_humidity_day_stop_dewpoint
  alias: "Patio AC - Day Humidity Stop (Dew Point)"
  description: "Stop day humidity control when dew point drops to day target"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_dew_point
      below: input_number.patio_ac_dewpoint_day_stop
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "humidity_day"
  action:
    - action: script.patio_ac_control
      data:
        action: "off"
        reason: "humidity_day"

- id: patio_ac_humidity_night_stop_dewpoint
  alias: "Patio AC - Night Humidity Stop (Dew Point)"
  description: "Stop night humidity control when dew point drops to night target"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.patio_dew_point
      below: input_number.patio_ac_dewpoint_night_stop
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "humidity_night"
  action:
    - action: script.patio_ac_control
      data:
        action: "off"
        reason: "humidity_night"

- id: patio_ac_timer_expired
  alias: "Patio AC - Timer Expiration Handler"
  description: "Turn off AC when duration timer expires"
  mode: single
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.patio_ac_heat_spike
  condition:
    - condition: template
      value_template: >
        {{ trigger.event.data.entity_id == 'timer.patio_ac_heat_spike' and
           states('input_select.patio_ac_reason') == 'heat_guard' }}
  action:
    - action: script.patio_ac_control
      data:
        action: "off"
        reason: "heat_guard"

- id: patio_ac_manual_override_detect
  alias: "Patio AC - Manual Override Detector"
  description: "Detect manual state changes via user context or expected signature"
  mode: single
  trigger:
    - platform: state
      entity_id: climate.patio_ac
  action:
    - variables:
        user_id: "{{ trigger.to_state.context.user_id }}"
        user_change: "{{ user_id is not none }}"
        ttl_active: "{{ now().timestamp() <= as_timestamp(states('input_datetime.patio_ac_expecting_change_until'), 0) }}"
        expected_sig: "{{ states('input_text.patio_ac_expected_signature') }}"
        sig_parts: "{{ expected_sig.split('|') if expected_sig else [] }}"
        exp_mode: "{{ sig_parts[0] if sig_parts|length > 0 else '' }}"
        exp_temp: "{{ sig_parts[1] if sig_parts|length > 1 else 'none' }}"
        actual_mode: "{{ trigger.to_state.state }}"
        actual_temp_raw: "{{ trigger.to_state.attributes.temperature if trigger.to_state.attributes.temperature is not none else none }}"
        actual_temp_known: "{{ actual_temp_raw is not none }}"
        actual_temp: "{{ actual_temp_raw | int(0) }}"
        mode_changed: "{{ trigger.from_state is not none and trigger.from_state.state != trigger.to_state.state }}"
        temp_changed: >
          {% set from_temp = trigger.from_state.attributes.temperature if trigger.from_state is not none else none %}
          {% set to_temp = trigger.to_state.attributes.temperature if trigger.to_state is not none else none %}
          {{ (from_temp is not none and to_temp is not none and (from_temp | int) != (to_temp | int)) or (from_temp is none and to_temp is not none) or (from_temp is not none and to_temp is none) }}
        signature_known: "{{ exp_mode not in ['', 'unknown', 'none', 'unavailable'] }}"
        temp_match: "{{ exp_mode == 'dry' or exp_temp == 'none' or (not actual_temp_known) or actual_temp == exp_temp|int }}"
        sig_match: "{{ signature_known and actual_mode == exp_mode and temp_match }}"
        ignore_user_change: "{{ user_change and ttl_active and sig_match }}"
        actual_off: "{{ actual_mode == 'off' }}"
        mismatch: "{{ signature_known and (actual_mode != exp_mode or not temp_match) }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ user_change and not ignore_user_change }}"
          sequence:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ actual_off }}"
                  sequence:
                    - action: input_select.select_option
                      target:
                        entity_id: input_select.patio_ac_reason
                      data:
                        option: "idle"
                    - action: timer.cancel
                      target:
                        entity_id: timer.patio_ac_manual_safety
                    - action: input_datetime.set_datetime
                      target:
                        entity_id: input_datetime.patio_ac_manual_until
                      data:
                        timestamp: "{{ now().timestamp() }}"
              default:
                - action: input_select.select_option
                  target:
                    entity_id: input_select.patio_ac_reason
                  data:
                    option: "manual"
                - action: input_datetime.set_datetime
                  target:
                    entity_id: input_datetime.patio_ac_manual_until
                  data:
                    timestamp: "{{ now().timestamp() }}"
                - action: timer.start
                  target:
                    entity_id: timer.patio_ac_manual_safety
        - conditions:
            - condition: template
              value_template: "{{ (not user_change) and (not ttl_active) and mismatch and (mode_changed or temp_changed) }}"
          sequence:
            - delay: "{{ states('input_number.patio_ac_poll_settle_seconds')|int }}"
            - condition: template
              value_template: >
                {% set ttl_active = now().timestamp() <= as_timestamp(states('input_datetime.patio_ac_expecting_change_until'), 0) %}
                {% set expected_sig = states('input_text.patio_ac_expected_signature') %}
                {% set parts = expected_sig.split('|') if expected_sig else [] %}
                {% set exp_mode = parts[0] if parts|length > 0 else '' %}
                {% set exp_temp = parts[1] if parts|length > 1 else 'none' %}
                {% set actual_mode = states('climate.patio_ac') %}
                {% set actual_temp_raw = state_attr('climate.patio_ac', 'temperature') %}
                {% set actual_temp_known = actual_temp_raw is not none %}
                {% set actual_temp = actual_temp_raw | int(0) %}
                {% set signature_known = exp_mode not in ['', 'unknown', 'none', 'unavailable'] %}
                {% set temp_match = exp_mode == 'dry' or exp_temp == 'none' or (not actual_temp_known) or actual_temp == exp_temp|int %}
                {% set mismatch = signature_known and (actual_mode != exp_mode or not temp_match) %}
                {{ (not ttl_active) and mismatch }}
            - variables:
                actual_mode: "{{ states('climate.patio_ac') }}"
                actual_off: "{{ states('climate.patio_ac') == 'off' }}"
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ actual_off }}"
                  sequence:
                    - action: input_select.select_option
                      target:
                        entity_id: input_select.patio_ac_reason
                      data:
                        option: "idle"
                    - action: timer.cancel
                      target:
                        entity_id: timer.patio_ac_manual_safety
                    - action: input_datetime.set_datetime
                      target:
                        entity_id: input_datetime.patio_ac_manual_until
                      data:
                        timestamp: "{{ now().timestamp() }}"
              default:
                - action: input_select.select_option
                  target:
                    entity_id: input_select.patio_ac_reason
                  data:
                    option: "manual"
                - action: input_datetime.set_datetime
                  target:
                    entity_id: input_datetime.patio_ac_manual_until
                  data:
                    timestamp: "{{ now().timestamp() }}"
                - action: timer.start
                  target:
                    entity_id: timer.patio_ac_manual_safety

- id: patio_ac_reason_reset_when_off
  alias: "Patio AC - Reset Reason When AC Is Off"
  description: "Return to Idle if an automation reason is set but the AC is OFF"
  mode: single
  trigger:
    - platform: state
      entity_id: climate.patio_ac
      to: "off"
  condition:
    - condition: template
      value_template: "{{ states('input_select.patio_ac_reason') in ['humidity_day','humidity_night','heat_guard'] }}"
  action:
    - delay: "{{ states('input_number.patio_ac_poll_settle_seconds')|int(0) + 2 }}"
    - condition: state
      entity_id: climate.patio_ac
      state: "off"
    - condition: template
      value_template: "{{ now().timestamp() > as_timestamp(states('input_datetime.patio_ac_expecting_change_until'), 0) }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states('input_select.patio_ac_reason') == 'heat_guard' }}"
          sequence:
            - action: timer.cancel
              target:
                entity_id: timer.patio_ac_heat_spike
    - action: input_select.select_option
      target:
        entity_id: input_select.patio_ac_reason
      data:
        option: "idle"

- id: patio_ac_manual_override_reset
  alias: "Patio AC - Resume Automation"
  description: "Explicitly clear manual authority so automation can run"
  mode: single
  trigger:
    - platform: state
      entity_id: input_button.patio_ac_resume_automation
  action:
    - action: input_select.select_option
      target:
        entity_id: input_select.patio_ac_reason
      data:
        option: "idle"
    - action: timer.cancel
      target:
        entity_id:
          - timer.patio_ac_manual_override
          - timer.patio_ac_manual_safety
    - action: input_datetime.set_datetime
      target:
        entity_id:
          - input_datetime.patio_ac_manual_until
          - input_datetime.patio_ac_expecting_change_until
      data:
        timestamp: "{{ now().timestamp() }}"

- id: patio_ac_safety_monitor
  alias: "Patio AC - Safety Monitor"
  description: "Prevent dangerous configurations (HEAT mode, etc.)"
  mode: single
  trigger:
    - platform: state
      entity_id: climate.patio_ac
      attribute: hvac_mode
      to: "heat"
  action:
    - action: input_select.select_option
      target:
        entity_id: input_select.patio_ac_reason
      data:
        option: "safety_lock"
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.patio_ac
      data:
        hvac_mode: "off"
    - action: persistent_notification.create
      data:
        title: "Patio AC Safety Lock"
        message: "AC was set to HEAT mode and has been disabled. Manual reset required."
        notification_id: "patio_ac_safety_lock"

- id: patio_ac_daily_limit_enforcer
  alias: "Patio AC - Automation Runtime Cap"
  description: "Stop automation runs when the daily automation cap is reached"
  mode: single
  trigger:
    - platform: template
      value_template: >
        {% set auto_hours = states('sensor.patio_ac_runtime_total_automation') | float(0) %}
        {% set auto_minutes = auto_hours * 60 %}
        {{ auto_minutes >= states('input_number.patio_ac_daily_limit') | float(0) }}
  condition:
    - condition: template
      value_template: "{{ states('climate.patio_ac') != 'off' }}"
    - condition: template
      value_template: "{{ states('input_select.patio_ac_reason') in ['heat_guard', 'humidity_day', 'humidity_night'] }}"
  action:
    - action: script.patio_ac_control
      data:
        action: "off"
        reason: "{{ states('input_select.patio_ac_reason') }}"
    - action: input_select.select_option
      target:
        entity_id: input_select.patio_ac_reason
      data:
        option: "safety_lock"
    - action: persistent_notification.create
      data:
        title: "Patio AC Automation Cap Reached"
        message: >
          Automation cap of {{ states('input_number.patio_ac_daily_limit')|int }} minutes reached.
          Automations disabled until midnight. Manual control still works.
        notification_id: "patio_ac_daily_limit"

- id: patio_ac_midnight_reset
  alias: "Patio AC - Midnight Runtime Reset"
  description: "Reset daily runtime counters at midnight"
  mode: single
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_daily_runtime
      data:
        value: 0
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_humidity_runtime
      data:
        value: 0
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.patio_ac_humidity_emergency_only
    - action: persistent_notification.dismiss
      data:
        notification_id: "patio_ac_humidity_soft_cap"
    - if:
        - condition: state
          entity_id: input_select.patio_ac_reason
          state: "safety_lock"
      then:
        - action: input_select.select_option
          target:
            entity_id: input_select.patio_ac_reason
          data:
            option: "idle"
        - action: persistent_notification.dismiss
          data:
            notification_id: "patio_ac_daily_limit"

- id: patio_ac_startup_recovery
  alias: "Patio AC - Startup Recovery"
  description: "Accumulate runtime and reconstruct visual timers from _until helpers"
  mode: single
  trigger:
    - platform: homeassistant
      event: start
  action:
    - if:
        - condition: template
          value_template: "{{ states('climate.patio_ac') != 'off' }}"
      then:
        - variables:
            elapsed: >
              {% set start = states('input_datetime.patio_ac_runtime_start') %}
              {% if start not in ['unknown', '', 'unavailable'] %}
                {{ (now().timestamp() - as_timestamp(start)) / 60 }}
              {% else %}
                0
              {% endif %}
        - action: input_number.set_value
          target:
            entity_id: input_number.patio_ac_daily_runtime
          data:
            value: "{{ (states('input_number.patio_ac_daily_runtime')|float + (elapsed|float))|round(1) }}"
        - if:
            - condition: template
              value_template: "{{ states('input_select.patio_ac_reason') in ['humidity_night','humidity_day'] }}"
          then:
            - action: input_number.set_value
              target:
                entity_id: input_number.patio_ac_humidity_runtime
              data:
                value: "{{ (states('input_number.patio_ac_humidity_runtime')|float + (elapsed|float))|round(1) }}"

    - repeat:
        for_each:
          - timer: timer.patio_ac_manual_override
            until: input_datetime.patio_ac_manual_until
          - timer: timer.patio_ac_compressor_protection
            until: input_datetime.patio_ac_compressor_protection_until
          - timer: timer.patio_ac_humidity_min_on
            until: input_datetime.patio_ac_humidity_min_on_until
          - timer: timer.patio_ac_humidity_min_off
            until: input_datetime.patio_ac_humidity_min_off_until
          - timer: timer.patio_ac_heat_spike
            until: input_datetime.patio_ac_heat_spike_until
          - timer: timer.patio_ac_command_throttle
            until: input_datetime.patio_ac_command_throttle_until
        sequence:
          - variables:
              remaining: "{{ as_timestamp(states(repeat.item.until), 0) - now().timestamp() }}"
          - if:
              - condition: template
                value_template: "{{ remaining > 0 }}"
            then:
              - action: timer.start
                target:
                  entity_id: "{{ repeat.item.timer }}"
                data:
                  duration: "{{ remaining | int }}"

- id: patio_ac_manual_safety_timeout
  alias: "Patio AC - Manual Safety Timeout (8 hours)"
  description: "Auto-stop AC after 8 hours of continuous manual use (safety net)"
  mode: single
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.patio_ac_manual_safety
  condition:
    - condition: state
      entity_id: input_select.patio_ac_reason
      state: "manual"
    - condition: template
      value_template: "{{ states('climate.patio_ac') != 'off' }}"
  action:
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.patio_ac
      data:
        hvac_mode: "off"
    - action: input_select.select_option
      target:
        entity_id: input_select.patio_ac_reason
      data:
        option: "idle"
    - action: persistent_notification.create
      data:
        title: "Patio AC Manual Safety Stop"
        message: >
          AC has been running for 8 hours continuously in manual mode.
          Auto-stopped as a safety measure. Turn it back on if still needed.
        notification_id: "patio_ac_manual_safety"

- id: patio_ac_boundary_handoff
  alias: "Patio AC - Schedule Cutover"
  description: "Stop or hand off between day/night humidity at schedule boundaries"
  mode: single
  initial_state: true
  trigger:
    - platform: time
      id: day_start
      at: input_datetime.patio_ac_day_start
    - platform: time
      id: night_start
      at: input_datetime.patio_ac_night_start
    - platform: time_pattern
      id: periodic
      minutes: "/5"
  action:
    - variables:
        current_reason: "{{ states('input_select.patio_ac_reason') }}"
        allow_seamless: "{{ is_state('input_boolean.patio_ac_allow_seamless_handoff', 'on') }}"
        ac_off: "{{ states('climate.patio_ac') == 'off' }}"
        dp_value: "{{ states('sensor.patio_dew_point') | float(default=none) }}"
        day_trigger: "{{ states('input_number.patio_ac_dewpoint_start') | float(default=none) }}"
        night_trigger: "{{ states('input_number.patio_ac_dewpoint_night_start') | float(default=none) }}"
        day_dp_target: "{{ states('input_number.patio_ac_dewpoint_day_stop') | float(default=none) }}"
        night_dp_target: "{{ states('input_number.patio_ac_dewpoint_night_stop') | float(default=none) }}"
        day_config_ok: "{{ day_trigger is not none and day_dp_target is not none and day_dp_target < day_trigger }}"
        night_config_ok: "{{ night_trigger is not none and night_dp_target is not none and night_dp_target < night_trigger }}"
        day_enabled: "{{ is_state('input_boolean.patio_ac_day_humidity_enabled', 'on') }}"
        night_enabled: "{{ is_state('input_boolean.patio_ac_night_humidity_enabled', 'on') }}"
        is_night: >
          {% set day_time = today_at(states('input_datetime.patio_ac_day_start')) %}
          {% set night_time = today_at(states('input_datetime.patio_ac_night_start')) %}
          {% if night_time > day_time %}
            {{ now() >= night_time or now() < day_time }}
          {% else %}
            {{ now() >= night_time and now() < day_time }}
          {% endif %}
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.id == 'night_start' or (trigger.id == 'periodic' and is_night) }}"
          sequence:
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {{ current_reason == 'humidity_day' and allow_seamless and night_enabled and
                           night_config_ok and dp_value is not none and dp_value >= night_trigger }}
                  sequence:
                    - action: input_select.select_option
                      target:
                        entity_id: input_select.patio_ac_reason
                      data:
                        option: "humidity_night"
                - conditions:
                    - condition: template
                      value_template: >
                        {{ current_reason == 'humidity_day' and
                           (not allow_seamless or not night_enabled or not night_config_ok or
                            dp_value is none or dp_value < night_trigger) }}
                  sequence:
                    - action: script.patio_ac_control
                      data:
                        action: "off"
                        reason: "humidity_day"
            - if:
                - condition: template
                  value_template: "{{ current_reason == 'humidity_day' and ac_off }}"
              then:
                - action: input_select.select_option
                  target:
                    entity_id: input_select.patio_ac_reason
                  data:
                    option: "idle"
            - if:
                - condition: template
                  value_template: >
                    {{ (not allow_seamless) and night_enabled and night_config_ok and
                       dp_value is not none and dp_value >= night_trigger }}
              then:
                - wait_template: "{{ is_state('timer.patio_ac_compressor_protection', 'idle') }}"
                  timeout: "00:15:00"
                - condition: template
                  value_template: >
                    {{ states('input_select.patio_ac_reason') == 'idle' and
                       states('climate.patio_ac') == 'off' }}
                - action: script.patio_ac_control
                  data:
                    action: "on"
                    mode: "dry"
                    temperature: "{{ states('input_number.patio_ac_default_dry_temp') | int }}"
                    reason: "humidity_night"
        - conditions:
            - condition: template
              value_template: "{{ trigger.id == 'day_start' or (trigger.id == 'periodic' and not is_night) }}"
          sequence:
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {{ current_reason == 'humidity_night' and allow_seamless and day_enabled and
                           day_config_ok and dp_value is not none and dp_value >= day_trigger }}
                  sequence:
                    - action: input_select.select_option
                      target:
                        entity_id: input_select.patio_ac_reason
                      data:
                        option: "humidity_day"
                - conditions:
                    - condition: template
                      value_template: >
                        {{ current_reason == 'humidity_night' and
                           (not allow_seamless or not day_enabled or not day_config_ok or
                            dp_value is none or dp_value < day_trigger) }}
                  sequence:
                    - action: script.patio_ac_control
                      data:
                        action: "off"
                        reason: "humidity_night"
            - if:
                - condition: template
                  value_template: "{{ current_reason == 'humidity_night' and ac_off }}"
              then:
                - action: input_select.select_option
                  target:
                    entity_id: input_select.patio_ac_reason
                  data:
                    option: "idle"
            - if:
                - condition: template
                  value_template: >
                    {{ (not allow_seamless) and day_enabled and day_config_ok and
                       dp_value is not none and dp_value >= day_trigger }}
              then:
                - wait_template: "{{ is_state('timer.patio_ac_compressor_protection', 'idle') }}"
                  timeout: "00:15:00"
                - condition: template
                  value_template: >
                    {{ states('input_select.patio_ac_reason') == 'idle' and
                       states('climate.patio_ac') == 'off' }}
                - action: script.patio_ac_control
                  data:
                    action: "on"
                    mode: "dry"
                    temperature: "{{ states('input_number.patio_ac_default_dry_temp') | int }}"
                    reason: "humidity_day"

# ============================================================================
# THRESHOLD VALIDATION AUTOMATIONS
# ============================================================================

- id: patio_ac_validate_day_humidity_trigger
  alias: "Patio AC - Validate Day Humidity Trigger"
  description: "When day trigger changes, ensure day target is at least 1 below"
  mode: single
  trigger:
    - platform: state
      entity_id: input_number.patio_ac_dewpoint_start
  condition:
    - condition: template
      value_template: >
        {{ states('input_number.patio_ac_dewpoint_day_stop') | float(0) >=
           states('input_number.patio_ac_dewpoint_start') | float(0) }}
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_dewpoint_day_stop
      data:
        value: "{{ (states('input_number.patio_ac_dewpoint_start') | float(0) - 1) | round(0) }}"

- id: patio_ac_validate_day_dewpoint_target
  alias: "Patio AC - Validate Day Dew Point Target"
  description: "When day target changes, ensure day trigger is at least 1 above"
  mode: single
  trigger:
    - platform: state
      entity_id: input_number.patio_ac_dewpoint_day_stop
  condition:
    - condition: template
      value_template: >
        {{ states('input_number.patio_ac_dewpoint_day_stop') | float(0) >=
           states('input_number.patio_ac_dewpoint_start') | float(0) }}
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_dewpoint_start
      data:
        value: "{{ (states('input_number.patio_ac_dewpoint_day_stop') | float(0) + 1) | round(0) }}"

- id: patio_ac_validate_night_humidity_trigger
  alias: "Patio AC - Validate Night Humidity Trigger"
  description: "When night trigger changes, ensure night target is at least 1 below"
  mode: single
  trigger:
    - platform: state
      entity_id: input_number.patio_ac_dewpoint_night_start
  condition:
    - condition: template
      value_template: >
        {{ states('input_number.patio_ac_dewpoint_night_stop') | float(0) >=
           states('input_number.patio_ac_dewpoint_night_start') | float(0) }}
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_dewpoint_night_stop
      data:
        value: "{{ (states('input_number.patio_ac_dewpoint_night_start') | float(0) - 1) | round(0) }}"

- id: patio_ac_validate_night_dewpoint_target
  alias: "Patio AC - Validate Night Dew Point Target"
  description: "When night target changes, ensure night trigger is at least 1 above"
  mode: single
  trigger:
    - platform: state
      entity_id: input_number.patio_ac_dewpoint_night_stop
  condition:
    - condition: template
      value_template: >
        {{ states('input_number.patio_ac_dewpoint_night_stop') | float(0) >=
           states('input_number.patio_ac_dewpoint_night_start') | float(0) }}
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_dewpoint_night_start
      data:
        value: "{{ (states('input_number.patio_ac_dewpoint_night_stop') | float(0) + 1) | round(0) }}"

- id: patio_ac_validate_heat_guard_trigger
  alias: "Patio AC - Validate Heat Guard Trigger"
  description: "When heat trigger changes, ensure target is at least 1° below"
  mode: single
  trigger:
    - platform: state
      entity_id: input_number.patio_ac_heat_threshold
  condition:
    - condition: template
      value_template: >
        {{ states('input_number.patio_ac_heat_target') | float(0) >=
           states('input_number.patio_ac_heat_threshold') | float(0) }}
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_heat_target
      data:
        value: "{{ (states('input_number.patio_ac_heat_threshold') | float(0) - 1) | round(0) }}"

- id: patio_ac_validate_heat_guard_target
  alias: "Patio AC - Validate Heat Guard Target"
  description: "When heat target changes, ensure trigger is at least 1 above"
  mode: single
  trigger:
    - platform: state
      entity_id: input_number.patio_ac_heat_target
  condition:
    - condition: template
      value_template: >
        {{ states('input_number.patio_ac_heat_threshold') | float(0) <=
           states('input_number.patio_ac_heat_target') | float(0) }}
  action:
    - action: input_number.set_value
      target:
        entity_id: input_number.patio_ac_heat_threshold
      data:
        value: "{{ (states('input_number.patio_ac_heat_target') | float(0) + 1) | round(0) }}"

# ============================================
# SCRIPTS
# Migrated from scripts.v2.8.yaml
# ============================================

script:
  patio_ac_control:
    alias: Patio AC Control (Protected)
    mode: queued
    max: 3
    fields:
      action:
        description: Turn on or off
        example: 'on'
        selector:
          select:
            options:
            - 'on'
            - 'off'
      mode:
        description: AC mode (if turning on)
        example: cool
        selector:
          select:
            options:
            - cool
            - dry
            - fan_only
      temperature:
        description: Target temperature (if turning on)
        example: 75
        selector:
          number:
            min: 61
            max: 86
            unit_of_measurement: "°F"
      reason:
        description: Reason for operation
        example: heat_guard
        selector:
          select:
            options:
            - heat_guard
            - humidity_night
            - humidity_day
            - humidity_emergency
            - manual
            - safety_lock
      duration:
        description: Max runtime in minutes (optional)
        example: 60
        selector:
          number:
            min: 0
            max: 1440
            unit_of_measurement: min
    sequence:
    - condition: state
      entity_id: timer.patio_ac_command_throttle
      state: idle
    - choose:
      - conditions:
        - condition: template
          value_template: "{{ action == 'on' }}"
        sequence:
        - condition: template
          value_template: >
            {% set auto_hours = states('sensor.patio_ac_runtime_total_automation') | float(0) %}
            {% set auto_minutes = auto_hours * 60 %}
            {{ reason not in ['heat_guard', 'humidity_day', 'humidity_night'] or
               auto_minutes < states('input_number.patio_ac_daily_limit') | float(0) }}
        - condition: or
          conditions:
          - condition: state
            entity_id: timer.patio_ac_compressor_protection
            state: idle
          - condition: template
            value_template: "{{ states('climate.patio_ac') != 'off' }}"
        - variables:
            ac_min_temp: 61
            ac_max_temp: 86
            clamped_temp: >
              {% if mode == 'cool' %}
                {{ [[temperature|int, ac_min_temp]|max, ac_max_temp]|min }}
              {% else %}
                {{ temperature|int(0) }}
              {% endif %}
        - condition: template
          value_template: >
            {{ states('climate.patio_ac') == 'off' or
               state_attr('climate.patio_ac', 'hvac_mode') != mode or
               (state_attr('climate.patio_ac', 'temperature')|int(0) != clamped_temp|int(0) if mode == 'cool' else false) }}
        - service: input_text.set_value
          target:
            entity_id: input_text.patio_ac_expected_signature
          data:
            value: >
              {% if mode == 'cool' %}
                cool|{{ clamped_temp }}
              {% elif mode == 'dry' %}
                dry|none
              {% else %}
                {{ mode }}|none
              {% endif %}
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_expecting_change_until
          data:
            timestamp: >
              {% set settle = states('input_number.patio_ac_poll_settle_seconds') | int(0) %}
              {{ now().timestamp() + settle + 10 }}
        - service: climate.set_hvac_mode
          target:
            entity_id: climate.patio_ac
          data:
            hvac_mode: "{{ mode }}"
        - if:
          - condition: template
            value_template: "{{ mode == 'cool' }}"
          then:
          - delay: "00:00:01"
          - service: climate.set_temperature
            target:
              entity_id: climate.patio_ac
            data:
              temperature: "{{ clamped_temp }}"
        - wait_template: >
            {% set sig = states('input_text.patio_ac_expected_signature').split('|') %}
            {% set target_mode = sig[0] %}
            {% set target_temp = sig[1] %}
            {{ is_state('climate.patio_ac', target_mode) and
               (state_attr('climate.patio_ac', 'temperature')|int(0) == target_temp|int(0) if target_temp != 'none' else true) }}
          timeout: "{{ states('input_number.patio_ac_poll_settle_seconds')|int }}"
        - if:
            - condition: template
              value_template: "{{ not wait.completed }}"
          then:
            - service: persistent_notification.create
              data:
                title: "Patio AC Command Failed"
                message: "Device failed to confirm ON state ({{ mode }}) within timeout."
                notification_id: "patio_ac_command_fail"
            - service: input_text.set_value
              target:
                entity_id: input_text.patio_ac_expected_signature
              data:
                value: ""
            - stop: "Command failed - device did not respond"
        - delay: 00:00:03
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_expecting_change_until
          data:
            timestamp: "{{ now().timestamp() }}"
        - service: input_select.select_option
          target:
            entity_id: input_select.patio_ac_reason
          data:
            option: "{{ reason }}"
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_runtime_start
          data:
            timestamp: "{{ now().timestamp() }}"
        - if:
          - condition: template
            value_template: "{{ duration is defined and duration|int > 0 and reason == 'heat_guard' }}"
          then:
          - service: timer.start
            target:
              entity_id: timer.patio_ac_heat_spike
            data:
              duration: "{{ '00:%02d:00'|format(duration|int) }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.patio_ac_heat_spike_until
            data:
              timestamp: "{{ now().timestamp() + (duration|int * 60) }}"
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_last_command
          data:
            timestamp: "{{ now().timestamp() }}"
        - service: timer.start
          target:
            entity_id: timer.patio_ac_command_throttle
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_command_throttle_until
          data:
            timestamp: "{{ now().timestamp() + 30 }}"
      - conditions:
        - condition: template
          value_template: "{{ action == 'off' }}"
        sequence:
        - condition: template
          value_template: >
            {{ states('input_select.patio_ac_reason') == reason or reason == 'safety_lock' }}
        - condition: template
          value_template: "{{ states('climate.patio_ac') != 'off' }}"
        - variables:
            run_duration: >
              {% set start = states('input_datetime.patio_ac_runtime_start') %}
              {% if start not in ['unknown', '', 'unavailable'] %}
                {{ (now().timestamp() - as_timestamp(start)) / 60 }}
              {% else %}
                0
              {% endif %}
            is_short_run: "{{ run_duration|float < states('input_number.patio_ac_min_meaningful_run_minutes')|float }}"
        - service: input_number.set_value
          target:
            entity_id: input_number.patio_ac_daily_runtime
          data:
            value: "{{ (states('input_number.patio_ac_daily_runtime')|float + run_duration|float)|round(1) }}"
        - if:
          - condition: template
            value_template: "{{ states('input_select.patio_ac_reason') in ['humidity_day','humidity_night'] }}"
          then:
          - service: input_number.set_value
            target:
              entity_id: input_number.patio_ac_humidity_runtime
            data:
              value: "{{ (states('input_number.patio_ac_humidity_runtime')|float + run_duration|float)|round(1) }}"
        - service: input_text.set_value
          target:
            entity_id: input_text.patio_ac_expected_signature
          data:
            value: "off|none"
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_expecting_change_until
          data:
            timestamp: >
              {% set settle = states('input_number.patio_ac_poll_settle_seconds') | int(0) %}
              {{ now().timestamp() + settle + 10 }}
        - service: climate.set_hvac_mode
          target:
            entity_id: climate.patio_ac
          data:
            hvac_mode: 'off'
        - wait_template: "{{ is_state('climate.patio_ac', 'off') }}"
          timeout: "{{ states('input_number.patio_ac_poll_settle_seconds')|int }}"
        - if:
            - condition: template
              value_template: "{{ not wait.completed }}"
          then:
            - service: persistent_notification.create
              data:
                title: "Patio AC Command Failed"
                message: "Device failed to confirm OFF state within timeout."
                notification_id: "patio_ac_command_fail"
            - service: input_text.set_value
              target:
                entity_id: input_text.patio_ac_expected_signature
              data:
                value: ""
            - stop: "Command failed - device did not respond"
        - delay: 00:00:03
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_expecting_change_until
          data:
            timestamp: "{{ now().timestamp() }}"
        - service: input_select.select_option
          target:
            entity_id: input_select.patio_ac_reason
          data:
            option: idle
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_last_off
          data:
            timestamp: "{{ now().timestamp() }}"
        - if:
            - condition: template
              value_template: >
                {% set cooldown = states('input_number.patio_ac_compressor_cooldown_minutes') | int(0) %}
                {{ (not is_short_run or reason == 'safety_lock') and cooldown > 0 }}
          then:
            - service: timer.start
              target:
                entity_id: timer.patio_ac_compressor_protection
              data:
                duration: "{{ '00:%02d:00'|format(states('input_number.patio_ac_compressor_cooldown_minutes')|int(0)) }}"
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.patio_ac_compressor_protection_until
              data:
                timestamp: "{{ now().timestamp() + (states('input_number.patio_ac_compressor_cooldown_minutes')|int(0) * 60) }}"
          else:
            - service: timer.cancel
              target:
                entity_id: timer.patio_ac_compressor_protection
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.patio_ac_compressor_protection_until
              data:
                timestamp: "{{ now().timestamp() }}"
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_last_command
          data:
            timestamp: "{{ now().timestamp() }}"
        - service: timer.start
          target:
            entity_id: timer.patio_ac_command_throttle
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.patio_ac_command_throttle_until
          data:
            timestamp: "{{ now().timestamp() + 30 }}"
