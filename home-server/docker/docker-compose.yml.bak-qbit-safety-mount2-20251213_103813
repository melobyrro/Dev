
services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "1080:1080/tcp"   # SOCKS5 proxy
      - "8181:8181/tcp"   # qBittorrent Web UI through VPN
      - "8191:8191/tcp"   # FlareSolverr through VPN
    environment:
      - VPN_SERVICE_PROVIDER=private internet access
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${PIA_USER}
      - OPENVPN_PASSWORD=${PIA_PASS}
      # - SERVER_REGIONS=US East
      - VPN_PORT_FORWARDING=on
      - TZ=America/New_York
      - SOCKS5_LOGGING=on
    volumes:
      - ./gluetun:/gluetun
      - /mnt/ByrroServer/docker-data/gluetun-tmp:/tmp/gluetun
    networks:
      - byrro-net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9999 >/dev/null && [ -s /tmp/gluetun/forwarded_port ]"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - WEBUI_PORT=8181
      - UMASK=002
    volumes:
      - /mnt/ByrroServer/docker-data/gluetun-tmp:/gluetun
      - /mnt/ByrroServer/docker-data/qbittorrent:/config
      - /mnt/ByrroServer/ByrroMedia/downloads:/downloads
    depends_on:
      gluetun:
        condition: service_healthy

  qb-port-sync:
    image: alpine:3.20
    container_name: qb-port-sync
    restart: unless-stopped
    network_mode: "service:gluetun"
    environment:
      QBIT_HOST: "http://127.0.0.1:8181"
      QBIT_USER: "${QBIT_USER}"
      QBIT_PASS: "${QBIT_PASS}"
      CHECK_INTERVAL: "60"
    volumes:
      - /mnt/ByrroServer/docker-data/gluetun-tmp:/gluetun:ro
      - /mnt/ByrroServer/docker-data/qb-port-sync:/app
    entrypoint: ["/bin/sh","-c","until [ -s /gluetun/forwarded_port ]; do echo 'waiting for forwarded_port'; sleep 5; done; apk add --no-cache curl >/dev/null && /app/update_port.sh"]
    depends_on:
      gluetun:
        condition: service_healthy


  qbit-safety-cleaner:
    image: alpine:3.20
    container_name: qbit-safety-cleaner
    restart: unless-stopped
    network_mode: "service:gluetun"
    environment:
      QBIT_HOST: "http://127.0.0.1:8181"
      QBIT_USER: "${QBIT_USER}"
      QBIT_PASS: "${QBIT_PASS}"
      INTERVAL: "300"
      CATEGORIES: "tv movies"
    volumes:
      - ./bin/qbit-safety-cleaner.sh:/app/qbit-safety-cleaner.sh:ro
    entrypoint: ["/bin/sh","-c","apk add --no-cache curl jq >/dev/null && /app/qbit-safety-cleaner.sh"]
    depends_on:
      gluetun:
        condition: service_healthy

  unpackerr:
    image: golift/unpackerr
    container_name: unpackerr
    restart: unless-stopped
    user: "1000:1000"
    environment:
      - TZ=America/New_York
      - UN_DEBUG=false
      - UN_LOG_FILE=/config/unpackerr.log
      - UN_SONARR_0_URL=http://sonarr:8989
      - UN_SONARR_0_API_KEY=3fa4c74b54044fffb69758c870758504
      - UN_SONARR_0_PATHS_0=/data/downloads
      - UN_SONARR_0_PROTOCOLS=torrent
      - UN_RADARR_0_URL=http://radarr:7878
      - UN_RADARR_0_API_KEY=09d8ec00241645b19c282a2adb199f0f
      - UN_RADARR_0_PATHS_0=/data/downloads
      - UN_RADARR_0_PROTOCOLS=torrent
    volumes:
      - /opt/appdata/unpackerr:/config
      - /mnt/ByrroServer/ByrroMedia:/data
    networks:
      - byrro-net

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - LOG_LEVEL=info
    depends_on:
      gluetun:
        condition: service_healthy

networks:
  byrro-net:
    external: true
