{% extends "base.html" %}

{% block title %}Chatbot - {{ channel.title }} - CultoTranscript{% endblock %}

{% block extra_css %}
<style>
    .chatbot-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        height: calc(100vh - 200px);
    }

    .chat-panel {
        display: flex;
        flex-direction: column;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }

    .chat-header {
        background: #2c3e50;
        color: white;
        padding: 1rem;
        font-weight: bold;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        max-width: 80%;
    }

    .message-user {
        background: #3498db;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .message-assistant {
        background: white;
        border: 1px solid #ddd;
        margin-right: auto;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }

    .message-citations {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #eee;
        font-size: 0.875rem;
    }

    .citation {
        display: block;
        color: #3498db;
        text-decoration: none;
        margin-top: 0.25rem;
    }

    .citation:hover {
        text-decoration: underline;
    }

    .chat-input-area {
        padding: 1rem;
        background: white;
        border-top: 1px solid #ddd;
    }

    .chat-input-form {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input-form input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .chat-input-form button {
        padding: 0.75rem 1.5rem;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    .chat-input-form button:hover {
        background: #2980b9;
    }

    .chat-input-form button:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .info-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
    }

    .info-card h3 {
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-size: 1rem;
    }

    .info-card p {
        font-size: 0.875rem;
        color: #555;
        line-height: 1.5;
    }

    .example-questions {
        list-style: none;
        padding: 0;
    }

    .example-questions li {
        padding: 0.5rem;
        margin-bottom: 0.25rem;
        background: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .example-questions li:hover {
        background: #e9ecef;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 1rem;
        color: #888;
    }

    .loading.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Chatbot - {{ channel.title }}</h2>
    <p style="color: #666; margin-bottom: 1rem;">
        Fa√ßa perguntas sobre os serm√µes deste canal. O assistente usa IA para responder
        baseando-se apenas no conte√∫do dos v√≠deos transcritos.
    </p>
</div>

<div class="chatbot-container">
    <div class="chat-panel">
        <div class="chat-header">
            Conversa com Assistente
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
            <div style="text-align: center; padding: 2rem; color: #888;">
                <p>üëã Ol√°! Como posso ajudar voc√™ a entender melhor os serm√µes deste canal?</p>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <p>‚è≥ Processando sua pergunta...</p>
        </div>

        <div class="chat-input-area">
            <form class="chat-input-form" id="chatForm">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="Digite sua pergunta aqui..."
                    required
                    autocomplete="off"
                >
                <button type="submit" id="sendButton">Enviar</button>
            </form>
        </div>
    </div>

    <div class="sidebar">
        <div class="info-card">
            <h3>Como funciona?</h3>
            <p>
                Este assistente usa Intelig√™ncia Artificial (Google Gemini) para buscar e
                responder suas perguntas sobre os serm√µes. Ele cita os v√≠deos espec√≠ficos
                de onde tirou a informa√ß√£o.
            </p>
        </div>

        <div class="info-card">
            <h3>Exemplos de perguntas</h3>
            <ul class="example-questions">
                <li onclick="askQuestion('Quais foram os principais temas pregados este m√™s?')">
                    Quais foram os principais temas pregados este m√™s?
                </li>
                <li onclick="askQuestion('O que foi falado sobre f√©?')">
                    O que foi falado sobre f√©?
                </li>
                <li onclick="askQuestion('Quais passagens de Jo√£o foram mais citadas?')">
                    Quais passagens de Jo√£o foram mais citadas?
                </li>
                <li onclick="askQuestion('Resumo dos √∫ltimos serm√µes sobre fam√≠lia')">
                    Resumo dos √∫ltimos serm√µes sobre fam√≠lia
                </li>
            </ul>
        </div>

        <div class="info-card">
            <h3>Limita√ß√µes</h3>
            <p>
                O assistente s√≥ pode responder com base nos v√≠deos j√° transcritos.
                Se n√£o encontrar a informa√ß√£o, ele dir√° que n√£o tem dados dispon√≠veis.
            </p>
        </div>
    </div>
</div>

<script>
    const channelId = {{ channel.id }};
    let sessionId = null;

    // Initialize session ID from localStorage or generate new one
    sessionId = localStorage.getItem(`chatbot_session_${channelId}`);
    if (!sessionId) {
        sessionId = generateSessionId();
        localStorage.setItem(`chatbot_session_${channelId}`, sessionId);
    }

    function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function askQuestion(question) {
        document.getElementById('messageInput').value = question;
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }

    function addMessage(role, content, citations = [], timestamp = new Date()) {
        const messagesDiv = document.getElementById('chatMessages');

        // Remove welcome message if exists
        const welcomeMsg = messagesDiv.querySelector('div[style*="text-align: center"]');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${role}`;

        let html = `<div>${escapeHtml(content)}</div>`;
        html += `<div class="message-time">${formatTime(timestamp)}</div>`;

        if (citations && citations.length > 0) {
            html += '<div class="message-citations"><strong>Fontes:</strong>';
            citations.forEach(citation => {
                const videoUrl = `/videos/${citation.video_id}?t=${citation.timestamp}`;
                html += `<a href="${videoUrl}" class="citation" target="_blank">
                    üìπ ${escapeHtml(citation.video_title)}
                </a>`;
            });
            html += '</div>';
        }

        messageDiv.innerHTML = html;
        messagesDiv.appendChild(messageDiv);

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTime(date) {
        return new Date(date).toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showLoading(show) {
        const loading = document.getElementById('loadingIndicator');
        const sendButton = document.getElementById('sendButton');
        const messageInput = document.getElementById('messageInput');

        if (show) {
            loading.classList.add('active');
            sendButton.disabled = true;
            messageInput.disabled = true;
        } else {
            loading.classList.remove('active');
            sendButton.disabled = false;
            messageInput.disabled = false;
        }
    }

    async function sendMessage(message) {
        // Add user message to chat
        addMessage('user', message);

        // Clear input
        document.getElementById('messageInput').value = '';

        // Show loading
        showLoading(true);

        try {
            const response = await fetch(`/api/channels/${channelId}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    session_id: sessionId
                })
            });

            if (!response.ok) {
                throw new Error('Erro ao enviar mensagem');
            }

            const data = await response.json();

            if (data.success) {
                // Update session ID
                sessionId = data.session_id;
                localStorage.setItem(`chatbot_session_${channelId}`, sessionId);

                // Add assistant response
                addMessage('assistant', data.response, data.cited_videos);
            } else {
                throw new Error(data.message || 'Erro desconhecido');
            }

        } catch (error) {
            console.error('Error:', error);
            addMessage('assistant', 'Desculpe, ocorreu um erro ao processar sua pergunta. Por favor, tente novamente.');
        } finally {
            showLoading(false);
        }
    }

    // Form submit handler
    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (message) {
            await sendMessage(message);
        }
    });
</script>
{% endblock %}
