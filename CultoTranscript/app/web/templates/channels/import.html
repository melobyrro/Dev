{% extends "base.html" %}

{% block title %}Importando Canal - CultoTranscript{% endblock %}

{% block extra_css %}
<style>
.import-container {
    max-width: 800px;
    margin: 0 auto;
}
.import-step {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    transition: all 0.3s;
}
.import-step.pending {
    opacity: 0.6;
}
.import-step.running {
    background: #fff9e6;
    border-color: #f39c12;
}
.import-step.completed {
    background: #e8f8f5;
    border-color: #2ecc71;
}
.import-step.failed {
    background: #fde8e8;
    border-color: #e74c3c;
}
.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 20px;
    flex-shrink: 0;
}
.step-icon.pending {
    background: #e0e0e0;
    color: #666;
}
.step-icon.running {
    background: #f39c12;
    color: white;
    animation: pulse 1.5s ease-in-out infinite;
}
.step-icon.completed {
    background: #2ecc71;
    color: white;
}
.step-icon.failed {
    background: #e74c3c;
    color: white;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
.step-content {
    flex: 1;
}
.step-title {
    font-weight: bold;
    margin-bottom: 0.25rem;
}
.step-details {
    font-size: 0.9rem;
    color: #666;
}
.progress-summary {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
}
.progress-bar-container {
    width: 100%;
    height: 20px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 1rem;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2ecc71);
    transition: width 0.5s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="import-container">
    <h1>Importando Canal: {{ channel.title }}</h1>

    <div class="progress-summary">
        <h2 id="summaryTitle">Preparando importação...</h2>
        <div class="progress-bar-container">
            <div class="progress-bar" id="overallProgress" style="width: 0%;"></div>
        </div>
        <p id="summaryDetails" style="margin-top: 1rem; color: #666;">Aguarde...</p>
    </div>

    <div class="card">
        <h3>Progresso da Importação</h3>
        <div id="importSteps">
            <div class="import-step pending">
                <div class="step-icon pending">⏸️</div>
                <div class="step-content">
                    <div class="step-title">Lendo dados do canal</div>
                    <div class="step-details">Extraindo informações do YouTube...</div>
                </div>
            </div>

            <div class="import-step pending">
                <div class="step-icon pending">⏸️</div>
                <div class="step-content">
                    <div class="step-title">Listando vídeos</div>
                    <div class="step-details">Buscando lista de vídeos do canal...</div>
                </div>
            </div>

            <div class="import-step pending">
                <div class="step-icon pending">⏸️</div>
                <div class="step-content">
                    <div class="step-title">Enfileirando transcrições</div>
                    <div class="step-details">Preparando vídeos para transcrição...</div>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 2rem; text-align: center;" id="actionButtons">
        <p style="color: #666;">Não feche esta página até a importação terminar.</p>
    </div>
</div>

<script>
let channelId = {{ channel.id }};
let pollInterval = null;
let currentVideoStep = 0;

async function pollImportStatus() {
    try {
        const response = await fetch(`/api/channels/${channelId}/import-status`);
        const data = await response.json();

        updateImportProgress(data);

        if (data.status === 'completed' || data.status === 'failed') {
            stopPolling();
            showCompletionActions(data.status);
        }
    } catch (error) {
        console.error('Error polling import status:', error);
    }
}

function updateImportProgress(data) {
    const steps = data.steps || {};
    const stepsContainer = document.getElementById('importSteps');

    // Update summary
    document.getElementById('summaryTitle').textContent = data.message || 'Importando...';
    document.getElementById('summaryDetails').textContent = data.details || '';

    // Update progress bar
    const progress = data.progress || 0;
    document.getElementById('overallProgress').style.width = `${progress}%`;

    // Render steps dynamically
    if (steps && Object.keys(steps).length > 0) {
        let html = '';
        Object.entries(steps).forEach(([key, step]) => {
            const statusClass = step.status || 'pending';
            const icon = {
                'pending': '⏸️',
                'running': '⏳',
                'completed': '✅',
                'failed': '❌'
            }[statusClass] || '⏸️';

            html += `
                <div class="import-step ${statusClass}">
                    <div class="step-icon ${statusClass}">${icon}</div>
                    <div class="step-content">
                        <div class="step-title">${step.title}</div>
                        <div class="step-details">${step.details || ''}</div>
                    </div>
                </div>
            `;
        });
        stepsContainer.innerHTML = html;
    }
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function showCompletionActions(status) {
    const actionsDiv = document.getElementById('actionButtons');
    if (status === 'completed') {
        actionsDiv.innerHTML = `
            <div class="alert alert-success" style="margin-bottom: 1rem;">
                <strong>✅ Importação concluída com sucesso!</strong>
            </div>
            <a href="/channels" class="btn">Ver Todos os Canais</a>
            <a href="/" class="btn btn-secondary" style="margin-left: 0.5rem;">Voltar ao Dashboard</a>
        `;
    } else {
        actionsDiv.innerHTML = `
            <div class="alert alert-error" style="margin-bottom: 1rem;">
                <strong>❌ A importação falhou.</strong>
            </div>
            <a href="/channels/new" class="btn">Tentar Novamente</a>
            <a href="/channels" class="btn btn-secondary" style="margin-left: 0.5rem;">Ver Canais</a>
        `;
    }
}

// Start polling
pollInterval = setInterval(pollImportStatus, 2000);
pollImportStatus(); // Initial call
</script>
{% endblock %}
