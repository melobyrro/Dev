{% extends "base.html" %}

{% block title %}Gerenciar Notificações YouTube{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Notificações em Tempo Real (WebSub)</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">
                Receba notificações automáticas quando novos vídeos forem publicados
            </p>
        </div>
        <a href="/admin" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
            Voltar ao Admin
        </a>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Inscrições</div>
            <div id="total-subs" class="text-3xl font-bold text-gray-900 dark:text-white mt-2">--</div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-600 dark:text-gray-400">Ativas</div>
            <div id="active-subs" class="text-3xl font-bold text-green-600 dark:text-green-400 mt-2">--</div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Notificações</div>
            <div id="total-notifications" class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2">--</div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-600 dark:text-gray-400">Última Notificação</div>
            <div id="last-notification" class="text-sm font-medium text-gray-900 dark:text-white mt-2">--</div>
        </div>
    </div>

    <!-- Subscriptions Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Inscrições Ativas</h2>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Canal
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Status
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Notificações
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Última Notificação
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Expira em
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody id="subscriptions-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Unsubscribed Channels -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mt-8">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Canais Sem Inscrição</h2>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Canal
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            ID do YouTube
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody id="unsubscribed-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
let subscriptions = [];
let channels = [];

async function loadData() {
    try {
        // Load subscriptions
        const subsResponse = await fetch('/api/websub/subscriptions');
        const subsData = await subsResponse.json();
        subscriptions = subsData.subscriptions || [];

        // Load all channels
        const channelsResponse = await fetch('/api/channels');
        const channelsData = await channelsResponse.json();
        channels = channelsData.channels || [];

        updateDashboard();
        renderSubscriptions();
        renderUnsubscribed();
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function updateDashboard() {
    const totalSubs = subscriptions.length;
    const activeSubs = subscriptions.filter(s => s.status === 'active').length;
    const totalNotifications = subscriptions.reduce((sum, s) => sum + (s.notification_count || 0), 0);

    // Find most recent notification
    let lastNotification = null;
    subscriptions.forEach(s => {
        if (s.last_notification) {
            const date = new Date(s.last_notification);
            if (!lastNotification || date > lastNotification) {
                lastNotification = date;
            }
        }
    });

    document.getElementById('total-subs').textContent = totalSubs;
    document.getElementById('active-subs').textContent = activeSubs;
    document.getElementById('total-notifications').textContent = totalNotifications;
    document.getElementById('last-notification').textContent = lastNotification
        ? lastNotification.toLocaleString('pt-BR')
        : 'Nunca';
}

function renderSubscriptions() {
    const tbody = document.getElementById('subscriptions-tbody');
    tbody.innerHTML = '';

    if (subscriptions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                    Nenhuma inscrição ativa
                </td>
            </tr>
        `;
        return;
    }

    subscriptions.forEach(sub => {
        const expiresAt = sub.expires_at ? new Date(sub.expires_at) : null;
        const now = new Date();
        const daysUntilExpiry = expiresAt ? Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24)) : null;

        const statusBadge = getStatusBadge(sub.status);
        const expiryText = daysUntilExpiry !== null
            ? (daysUntilExpiry > 0 ? `${daysUntilExpiry} dias` : 'Expirada')
            : '--';
        const expiryClass = daysUntilExpiry !== null && daysUntilExpiry < 2
            ? 'text-red-600 dark:text-red-400 font-semibold'
            : 'text-gray-900 dark:text-white';

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
        row.innerHTML = `
            <td class="px-6 py-4">
                <div class="font-medium text-gray-900 dark:text-white">${sub.channel_name || 'Canal desconhecido'}</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">${sub.youtube_channel_id}</div>
            </td>
            <td class="px-6 py-4">${statusBadge}</td>
            <td class="px-6 py-4 text-gray-900 dark:text-white">${sub.notification_count || 0}</td>
            <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                ${sub.last_notification ? new Date(sub.last_notification).toLocaleString('pt-BR') : 'Nunca'}
            </td>
            <td class="px-6 py-4 text-sm ${expiryClass}">${expiryText}</td>
            <td class="px-6 py-4 text-right">
                <button onclick="unsubscribe(${sub.channel_id})"
                    class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm font-medium">
                    Desinscrever
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderUnsubscribed() {
    const subscribedChannelIds = new Set(subscriptions.map(s => s.channel_id));
    const unsubscribed = channels.filter(c => c.active && !subscribedChannelIds.has(c.id));

    const tbody = document.getElementById('unsubscribed-tbody');
    tbody.innerHTML = '';

    if (unsubscribed.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                    Todos os canais ativos estão inscritos
                </td>
            </tr>
        `;
        return;
    }

    unsubscribed.forEach(channel => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
        row.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${channel.title}</td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${channel.youtube_channel_id || 'Não configurado'}</td>
            <td class="px-6 py-4 text-right">
                ${channel.youtube_channel_id
                    ? `<button onclick="subscribe(${channel.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Inscrever</button>`
                    : `<span class="text-sm text-gray-400">ID do YouTube necessário</span>`
                }
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Ativa</span>',
        'pending': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pendente</span>',
        'expired': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Expirada</span>',
        'failed': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">Falhou</span>'
    };
    return badges[status] || badges['failed'];
}

async function subscribe(channelId) {
    if (!confirm('Deseja inscrever-se nas notificações deste canal?')) return;

    try {
        const response = await fetch(`/api/websub/subscribe/${channelId}`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            alert('Inscrição realizada com sucesso!');
            loadData();
        } else {
            alert('Erro ao inscrever: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Error subscribing:', error);
        alert('Erro ao inscrever no canal');
    }
}

async function unsubscribe(channelId) {
    if (!confirm('Deseja cancelar as notificações deste canal?')) return;

    try {
        const response = await fetch(`/api/websub/unsubscribe/${channelId}`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            alert('Inscrição cancelada com sucesso!');
            loadData();
        } else {
            alert('Erro ao desinscrever: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Error unsubscribing:', error);
        alert('Erro ao desinscrever do canal');
    }
}

// Auto-refresh every 30 seconds
setInterval(loadData, 30000);

// Initial load
loadData();
</script>
{% endblock %}
