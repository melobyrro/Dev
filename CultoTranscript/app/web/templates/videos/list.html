{% extends "base.html" %}

{% block title %}Vídeos - CultoTranscript{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-6 tracking-tight">Vídeos</h1>

<!-- Filter Form -->
<form method="GET" action="/videos" class="mb-6" style="background: var(--muted); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border);">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
        <!-- Search by title -->
        <div>
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-muted);">Buscar Título</label>
            <input type="text" name="search" value="{{ current_search }}"
                   placeholder="Digite para buscar..."
                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
        </div>

        <!-- Speaker filter -->
        <div>
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-muted);">Pregador</label>
            <select name="speaker" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
                <option value="">Todos os pregadores</option>
                {% for spk in speakers %}
                <option value="{{ spk.name }}" {% if current_speaker == spk.name %}selected{% endif %}>
                    {{ spk.name }} ({{ spk.video_count }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Status filter -->
        <div>
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-muted);">Status</label>
            <select name="status" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
                <option value="">Todos os status</option>
                <option value="completed" {% if current_status == "completed" %}selected{% endif %}>Completo</option>
                <option value="processing" {% if current_status == "processing" %}selected{% endif %}>Processando</option>
                <option value="failed" {% if current_status == "failed" %}selected{% endif %}>Falhou</option>
                <option value="pending" {% if current_status == "pending" %}selected{% endif %}>Pendente</option>
                <option value="too_long" {% if current_status == "too_long" %}selected{% endif %}>Muito Longo</option>
                <option value="skipped" {% if current_status == "skipped" %}selected{% endif %}>Ignorado</option>
            </select>
        </div>

        <!-- Date range -->
        <div>
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-muted);">Data Início</label>
            <input type="date" name="date_start" value="{{ current_date_start }}"
                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
        </div>

        <div>
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-muted);">Data Fim</label>
            <input type="date" name="date_end" value="{{ current_date_end }}"
                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
        </div>
    </div>

    <div style="display: flex; gap: 0.5rem;">
        <button type="submit" style="padding: 0.5rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
            Filtrar
        </button>
        <a href="/videos" style="padding: 0.5rem 1.5rem; background: var(--text-muted); color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
            Limpar Filtros
        </a>
    </div>
</form>

<!-- Bulk Actions Bar (hidden by default) -->
<div id="bulk-actions-bar" style="display: none;" class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg flex items-center gap-4">
    <span id="selected-count" class="font-semibold text-blue-900 dark:text-blue-100">0 vídeos selecionados</span>
    <button onclick="openMergeModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
        Mesclar Vídeos Selecionados
    </button>
    <button onclick="clearSelection()" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
        Limpar Seleção
    </button>
</div>

<div class="overflow-hidden">
    <table class="w-full">
        <thead class="bg-secondary text-primary">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    <input type="checkbox" id="select-all-videos" onchange="toggleSelectAll()" class="rounded">
                </th>
                <th class="px-4 py-3 text-left">
                    <a href="/videos?sort=title&order={% if current_sort == 'title' and current_order == 'asc' %}desc{% else %}asc{% endif %}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}"
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                        Título
                        {% if current_sort == "title" %}
                            <span>{% if current_order == "asc" %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="px-4 py-3 text-left">YouTube ID</th>
                <th class="px-4 py-3 text-left">
                    <a href="/videos?sort=speaker&order={% if current_sort == 'speaker' and current_order == 'asc' %}desc{% else %}asc{% endif %}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}"
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                        Pregador
                        {% if current_sort == "speaker" %}
                            <span>{% if current_order == "asc" %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="px-4 py-3 text-left">
                    <a href="/videos?sort=status&order={% if current_sort == 'status' and current_order == 'asc' %}desc{% else %}asc{% endif %}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}"
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                        Status
                        {% if current_sort == "status" %}
                            <span>{% if current_order == "asc" %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="px-4 py-3 text-left">
                    <a href="/videos?sort=duration_sec&order={% if current_sort == 'duration_sec' and current_order == 'asc' %}desc{% else %}asc{% endif %}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}"
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                        Duração
                        {% if current_sort == "duration_sec" %}
                            <span>{% if current_order == "asc" %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="px-4 py-3 text-left">
                    <a href="/videos?sort=published_at&order={% if current_sort == 'published_at' and current_order == 'asc' %}desc{% else %}asc{% endif %}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}"
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                        Data
                        {% if current_sort == "published_at" %}
                            <span>{% if current_order == "asc" %}▲{% else %}▼{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="px-4 py-3 text-left">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for video in videos %}
            <tr>
                <td class="px-4 py-3">
                    <input type="checkbox"
                           class="video-checkbox rounded"
                           data-video-id="{{ video.id }}"
                           data-channel-id="{{ video.channel_id }}"
                           data-status="{{ video.status }}"
                           data-title="{{ video.title }}"
                           data-duration="{{ video.duration_sec }}"
                           onchange="updateMergeButton()">
                </td>
                <td class="px-4 py-3 text-sm">{{ video.title }}</td>
                <td class="px-4 py-3 text-sm text-secondary font-mono">{{ video.youtube_id }}</td>
                <!-- Speaker column with inline editor -->
                <td class="px-4 py-3 text-sm">
                    <div id="speaker-display-{{ video.id }}" style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="speaker-text-{{ video.id }}" style="color: var(--text);">
                            {{ video.speaker or "Não definido" }}
                        </span>
                        <button onclick="toggleSpeakerEdit({{ video.id }})"
                                style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.25rem;">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="speaker-edit-{{ video.id }}" style="display: none;">
                        <div style="display: flex; gap: 0.25rem; position: relative;">
                            <input type="text"
                                   id="speaker-input-{{ video.id }}"
                                   value="{{ video.speaker or '' }}"
                                   oninput="handleSpeakerInput({{ video.id }}, this.value)"
                                   placeholder="Digite o nome do pregador..."
                                   style="flex: 1; padding: 0.25rem 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem; background: var(--surface); color: var(--text);">
                            <button onclick="saveSpeaker({{ video.id }})"
                                    style="padding: 0.25rem 0.5rem; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                Salvar
                            </button>
                            <button onclick="cancelSpeakerEdit({{ video.id }}, '{{ video.speaker or '' }}')"
                                    style="padding: 0.25rem 0.5rem; background: #6b7280; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                Cancelar
                            </button>
                        </div>
                        <div id="speaker-suggestions-{{ video.id }}"
                             style="position: absolute; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; z-index: 10; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3"><span class="status status-{{ video.status }}">{{ video.status }}</span></td>
                <td class="px-4 py-3 text-sm text-secondary">{{ (video.duration_sec / 60)|int }} min</td>
                <td class="px-4 py-3 text-sm">
                    <div><strong>Publicado:</strong> {{ (video.published_at).strftime('%m/%d/%Y') }}</div>
                    <div>
                        <strong>Data do culto:</strong>
                        <span id="sermon-date-display-{{ video.id }}" data-iso="{{ video.sermon_actual_date.strftime('%Y-%m-%d') if video.sermon_actual_date else '' }}">
                            {% if video.sermon_actual_date %}
                                {{ video.sermon_actual_date.strftime('%m/%d/%Y') }}
                            {% else %}
                                Não definido
                            {% endif %}
                        </span>
                        <button onclick="editSermonDateInline({{ video.id }})"
                                style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.2rem;">
                            ✏️
                        </button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Adicionado: {{ (video.ingested_at or video.created_at).strftime('%m/%d/%Y') }}</div>
                </td>
                <td class="px-4 py-3" onclick="event.stopPropagation();">
                    <a href="/?expand={{ video.id }}" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.85rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px;">Ver</a>
                    <button onclick="reprocessVideo({{ video.id }}, '{{ video.title.replace("'", "\\'") }}')"
                            class="btn"
                            style="padding: 0.3rem 0.6rem; font-size: 0.85rem; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 0.3rem;">
                        Reprocessar
                    </button>
                    <button onclick="excludeVideo({{ video.id }}, '{{ video.title.replace("'", "\\'") }}')"
                            class="btn"
                            style="padding: 0.3rem 0.6rem; font-size: 0.85rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 0.3rem;">
                        Excluir
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="mt-6 flex items-center justify-center gap-4">
    {% if page > 1 %}
    <a href="/videos?page={{ page - 1 }}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}&sort={{ current_sort }}&order={{ current_order }}" class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary-dark text-white text-sm font-medium rounded-md transition-all duration-200">
        Anterior
    </a>
    {% endif %}
    <span class="text-sm text-secondary">Página {{ page }} de {{ pages }}</span>
    {% if page < pages %}
    <a href="/videos?page={{ page + 1 }}&search={{ current_search }}&speaker={{ current_speaker }}&status={{ current_status }}&date_start={{ current_date_start }}&date_end={{ current_date_end }}&sort={{ current_sort }}&order={{ current_order }}" class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary-dark text-white text-sm font-medium rounded-md transition-all duration-200">
        Próxima
    </a>
    {% endif %}
</div>

<!-- Video Merge Modal -->
<div id="merge-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4" style="max-height: 90vh; overflow-y: auto;">

        <!-- Step 1: Select Primary Video -->
        <div id="merge-step-1">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Mesclar Vídeos - Etapa 1/2</h2>
            <p class="mb-4 text-gray-700 dark:text-gray-300">Selecione qual vídeo será o principal (manterá YouTube ID, título, speaker, etc.):</p>

            <div id="primary-video-selection" class="space-y-2 mb-6">
                <!-- Radio buttons will be inserted here by JavaScript -->
            </div>

            <div class="flex gap-3">
                <button onclick="mergeStep2()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    Próximo →
                </button>
                <button onclick="closeMergeModal()" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>

        <!-- Step 2: Confirm Merge -->
        <div id="merge-step-2" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Mesclar Vídeos - Etapa 2/2</h2>

            <div class="mb-4">
                <p class="font-semibold text-gray-900 dark:text-white">Vídeo Principal:</p>
                <p id="primary-video-title" class="text-gray-700 dark:text-gray-300 ml-4"></p>
            </div>

            <div class="mb-4">
                <p class="font-semibold text-gray-900 dark:text-white">Vídeos que serão mesclados e excluídos:</p>
                <ul id="secondary-videos-list" class="text-gray-700 dark:text-gray-300 ml-4 list-disc list-inside">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>

            <div class="mb-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-300 dark:border-yellow-700 rounded-lg">
                <p class="font-bold text-yellow-900 dark:text-yellow-100 mb-2">⚠️ Atenção:</p>
                <ul class="text-sm text-yellow-800 dark:text-yellow-200 space-y-1">
                    <li>• As transcrições serão concatenadas em ordem cronológica</li>
                    <li id="total-duration-info">• Duração total: <span id="total-duration"></span></li>
                    <li>• Os vídeos secundários serão <strong>excluídos permanentemente</strong></li>
                    <li>• Esta ação <strong>NÃO pode ser desfeita</strong></li>
                    <li id="status-warning" style="display: none;">• <strong>Aviso</strong>: Os vídeos têm status diferentes!</li>
                </ul>
            </div>

            <div class="mb-4">
                <label class="block font-medium text-gray-900 dark:text-white mb-2">Digite a senha de admin para confirmar:</label>
                <input type="password"
                       id="merge-password"
                       placeholder="Senha"
                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                       onkeypress="if(event.key === 'Enter') executeMerge()">
            </div>

            <div class="flex gap-3">
                <button onclick="executeMerge()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                    ✓ Confirmar Mesclagem
                </button>
                <button onclick="mergeStep1()" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    ← Voltar
                </button>
                <button onclick="closeMergeModal()" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>

            <div id="merge-message" class="mt-4" style="display: none;"></div>
        </div>

        <!-- Step 3: Progress -->
        <div id="merge-step-3" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Mesclando Vídeos...</h2>
            <div class="mb-4">
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                    <div id="merge-progress" class="bg-green-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <p id="merge-status" class="text-center text-gray-700 dark:text-gray-300">Processando...</p>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let csrfToken = null;

function formatDateLabel(dateStr) {
    if (!dateStr) return 'Não definido';
    const [year, month, day] = dateStr.split('-');
    return `${month}/${day}/${year}`;
}

async function editSermonDateInline(videoId) {
    const display = document.getElementById(`sermon-date-display-${videoId}`);
    if (!display) return;

    const currentIso = display.dataset.iso || '';
    const newValue = prompt("Informe a data real do culto (YYYY-MM-DD). Deixe vazio para remover.", currentIso);

    if (newValue === null) {
        return;
    }

    const trimmed = newValue.trim();
    if (trimmed && !/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
        alert("Formato inválido. Use YYYY-MM-DD.");
        return;
    }

    try {
        const response = await fetch(`/api/videos/${videoId}/sermon-date`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sermon_actual_date: trimmed || null })
        });

        const data = await response.json();
        if (data.success) {
            display.dataset.iso = data.sermon_actual_date || '';
            display.textContent = formatDateLabel(data.sermon_actual_date);
            alert('Data do culto atualizada!');
        } else {
            alert(data.detail || 'Erro ao atualizar data do culto');
        }
    } catch (error) {
        alert(`Erro ao atualizar data do culto: ${error.message}`);
    }
}

// Refresh CSRF token from server
async function refreshCSRFToken() {
    try {
        const response = await fetch(`/api/videos?limit=1`);
        const newToken = response.headers.get('X-CSRF-Token');
        if (newToken) {
            csrfToken = newToken;
            return true;
        }
        console.warn('No CSRF token in response headers');
        return false;
    } catch (error) {
        console.error('Failed to refresh CSRF token:', error);
        return false;
    }
}

// Reprocess video function
async function reprocessVideo(videoId, title) {
    // Refresh CSRF token before operation
    if (!await refreshCSRFToken()) {
        alert('Erro: Não foi possível validar a sessão. Por favor, recarregue a página.');
        return;
    }

    // Prompt for password
    const password = prompt(`Reprocessar vídeo "${title}"?\n\nEsta ação irá:\n- Re-executar detecção de início do sermão\n- Regenerar análise de IA e resumo\n- Atualizar todos os dados analíticos\n\nDigite a senha de admin para confirmar:`);

    if (!password) {
        return; // User cancelled
    }

    try {
        const response = await fetch(`/api/videos/${videoId}/reprocess`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ password: password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            alert(`Reprocessamento iniciado! O vídeo será reanalizado em alguns minutos.`);
            // Reload page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert(`Erro: ${data.detail || 'Falha ao iniciar reprocessamento'}`);
        }
    } catch (error) {
        alert(`Erro ao reprocessar vídeo: ${error.message}`);
    }
}

// Exclude video function (uses /exclude endpoint)
async function excludeVideo(videoId, title) {
    // Refresh CSRF token before operation
    if (!await refreshCSRFToken()) {
        alert('Erro: Não foi possível validar a sessão. Por favor, recarregue a página.');
        return;
    }

    // Prompt for password
    const password = prompt(`Excluir vídeo "${title}"?\n\nIsso irá remover permanentemente:\n- Vídeo\n- Transcrição\n- Todos os dados relacionados\n\nDigite a senha de admin para confirmar:`);

    if (!password) {
        return; // User cancelled
    }

    try {
        const response = await fetch(`/api/videos/${videoId}/exclude`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ password: password })
        });

        const data = await response.json();

        if (data.success) {
            alert(`Vídeo excluído com sucesso!`);
            // Reload page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert(`Erro ao excluir vídeo: ${data.detail || 'Erro desconhecido'}`);
        }
    } catch (error) {
        alert(`Erro ao excluir vídeo: ${error.message}`);
    }
}

// Toggle speaker edit mode
function toggleSpeakerEdit(videoId) {
    const displayDiv = document.getElementById(`speaker-display-${videoId}`);
    const editDiv = document.getElementById(`speaker-edit-${videoId}`);

    displayDiv.style.display = 'none';
    editDiv.style.display = 'block';

    // Focus the input
    const input = document.getElementById(`speaker-input-${videoId}`);
    input.focus();
}

// Cancel speaker edit
function cancelSpeakerEdit(videoId, originalValue) {
    const displayDiv = document.getElementById(`speaker-display-${videoId}`);
    const editDiv = document.getElementById(`speaker-edit-${videoId}`);
    const input = document.getElementById(`speaker-input-${videoId}`);
    const suggestionsDiv = document.getElementById(`speaker-suggestions-${videoId}`);

    // Reset to original value
    input.value = originalValue;

    // Hide edit mode
    editDiv.style.display = 'none';
    displayDiv.style.display = 'flex';

    // Hide suggestions
    suggestionsDiv.style.display = 'none';
}

// Save speaker
async function saveSpeaker(videoId) {
    const input = document.getElementById(`speaker-input-${videoId}`);
    const newSpeaker = input.value.trim();

    if (!csrfToken) {
        await refreshCSRFToken();
    }

    try {
        const response = await fetch(`/api/videos/${videoId}/speaker`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ speaker: newSpeaker })
        });

        if (response.ok) {
            // Update display text
            const textSpan = document.getElementById(`speaker-text-${videoId}`);
            textSpan.textContent = newSpeaker || "Não definido";

            // Hide edit mode
            const displayDiv = document.getElementById(`speaker-display-${videoId}`);
            const editDiv = document.getElementById(`speaker-edit-${videoId}`);
            editDiv.style.display = 'none';
            displayDiv.style.display = 'flex';

            // Hide suggestions
            const suggestionsDiv = document.getElementById(`speaker-suggestions-${videoId}`);
            suggestionsDiv.style.display = 'none';

            console.log('Speaker updated successfully');
        } else {
            alert('Erro ao salvar pregador. Tente novamente.');
        }
    } catch (error) {
        console.error('Error saving speaker:', error);
        alert('Erro ao salvar pregador. Tente novamente.');
    }
}

// Debounce timer for autocomplete
let speakerDebounceTimer = null;

// Handle speaker input with autocomplete
async function handleSpeakerInput(videoId, value) {
    clearTimeout(speakerDebounceTimer);

    const suggestionsDiv = document.getElementById(`speaker-suggestions-${videoId}`);

    if (value.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }

    speakerDebounceTimer = setTimeout(async () => {
        try {
            const response = await fetch(`/api/speakers/autocomplete?q=${encodeURIComponent(value)}`);
            const data = await response.json();

            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsDiv.innerHTML = data.suggestions.map(speaker => `
                    <div onclick="selectSpeaker(${videoId}, '${speaker.name.replace(/'/g, "\\'")}')"
                         style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text);"
                         onmouseover="this.style.background='var(--muted)'"
                         onmouseout="this.style.background='var(--surface)'">
                        <div style="font-weight: 500;">${speaker.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${speaker.video_count} vídeos</div>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (error) {
            console.error('Error fetching speaker suggestions:', error);
        }
    }, 300);
}

// Select speaker from autocomplete
function selectSpeaker(videoId, name) {
    const input = document.getElementById(`speaker-input-${videoId}`);
    const suggestionsDiv = document.getElementById(`speaker-suggestions-${videoId}`);

    input.value = name;
    suggestionsDiv.style.display = 'none';
}

// Initialize CSRF token on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshCSRFToken();
});

// ============================================================================
// Video Merge Functionality
// ============================================================================

let selectedVideos = new Set();
let mergeData = {
    primaryVideoId: null,
    videos: []
};

function toggleSelectAll() {
    const selectAll = document.getElementById('select-all-videos');
    const checkboxes = document.querySelectorAll('.video-checkbox');

    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
    });

    updateMergeButton();
}

function updateMergeButton() {
    const checkboxes = document.querySelectorAll('.video-checkbox:checked');
    const bulkBar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('selected-count');

    selectedVideos.clear();

    checkboxes.forEach(cb => {
        selectedVideos.add({
            id: parseInt(cb.dataset.videoId),
            channelId: parseInt(cb.dataset.channelId),
            status: cb.dataset.status,
            title: cb.dataset.title,
            duration: parseInt(cb.dataset.duration)
        });
    });

    if (selectedVideos.size >= 2) {
        bulkBar.style.display = 'flex';
        countSpan.textContent = `${selectedVideos.size} vídeos selecionados`;
    } else {
        bulkBar.style.display = 'none';
    }
}

function clearSelection() {
    document.querySelectorAll('.video-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all-videos').checked = false;
    updateMergeButton();
}

function openMergeModal() {
    // Validate same channel
    const channels = new Set([...selectedVideos].map(v => v.channelId));
    if (channels.size > 1) {
        alert('Erro: Todos os vídeos devem ser do mesmo canal!');
        return;
    }

    mergeData.videos = Array.from(selectedVideos);

    // Show modal
    document.getElementById('merge-modal').style.display = 'flex';

    // Populate primary selection
    const selectionDiv = document.getElementById('primary-video-selection');
    selectionDiv.innerHTML = '';

    mergeData.videos.forEach(video => {
        const div = document.createElement('div');
        div.className = 'p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer';
        div.innerHTML = `
            <label class="flex items-center cursor-pointer">
                <input type="radio" name="primary-video" value="${video.id}" class="mr-3">
                <span class="text-gray-900 dark:text-white">${video.title}</span>
                <span class="ml-auto text-sm text-gray-500 dark:text-gray-400">(${video.status})</span>
            </label>
        `;
        selectionDiv.appendChild(div);
    });

    // Show step 1
    document.getElementById('merge-step-1').style.display = 'block';
    document.getElementById('merge-step-2').style.display = 'none';
    document.getElementById('merge-step-3').style.display = 'none';
}

function closeMergeModal() {
    document.getElementById('merge-modal').style.display = 'none';
    mergeData = { primaryVideoId: null, videos: [] };
}

function mergeStep1() {
    document.getElementById('merge-step-1').style.display = 'block';
    document.getElementById('merge-step-2').style.display = 'none';
}

function mergeStep2() {
    // Get selected primary
    const selectedRadio = document.querySelector('input[name="primary-video"]:checked');
    if (!selectedRadio) {
        alert('Por favor, selecione o vídeo principal!');
        return;
    }

    mergeData.primaryVideoId = parseInt(selectedRadio.value);
    const primary = mergeData.videos.find(v => v.id === mergeData.primaryVideoId);
    const secondaries = mergeData.videos.filter(v => v.id !== mergeData.primaryVideoId);

    // Update step 2 UI
    document.getElementById('primary-video-title').textContent = primary.title;

    const secondaryList = document.getElementById('secondary-videos-list');
    secondaryList.innerHTML = '';
    secondaries.forEach(video => {
        const li = document.createElement('li');
        li.textContent = video.title;
        secondaryList.appendChild(li);
    });

    // Check if different statuses
    const statuses = new Set(mergeData.videos.map(v => v.status));
    if (statuses.size > 1) {
        document.getElementById('status-warning').style.display = 'list-item';
    } else {
        document.getElementById('status-warning').style.display = 'none';
    }

    // Calculate total duration
    const totalDurationSec = mergeData.videos.reduce((sum, v) => sum + v.duration, 0);
    const totalMinutes = Math.floor(totalDurationSec / 60);
    const totalHours = Math.floor(totalMinutes / 60);
    const remainingMinutes = totalMinutes % 60;

    let durationText = '';
    if (totalHours > 0) {
        durationText = `${totalHours}h ${remainingMinutes}min`;
    } else {
        durationText = `${totalMinutes}min`;
    }
    document.getElementById('total-duration').textContent = durationText;

    // Show step 2
    document.getElementById('merge-step-1').style.display = 'none';
    document.getElementById('merge-step-2').style.display = 'block';
    document.getElementById('merge-password').focus();
}

async function executeMerge() {
    const password = document.getElementById('merge-password').value;

    if (!password) {
        alert('Por favor, digite a senha de admin!');
        return;
    }

    // Show progress step
    document.getElementById('merge-step-2').style.display = 'none';
    document.getElementById('merge-step-3').style.display = 'block';
    document.getElementById('merge-progress').style.width = '30%';
    document.getElementById('merge-status').textContent = 'Enviando requisição...';

    try {
        const response = await fetch('/api/videos/merge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_ids: mergeData.videos.map(v => v.id),
                primary_video_id: mergeData.primaryVideoId,
                password: password
            })
        });

        document.getElementById('merge-progress').style.width = '70%';
        document.getElementById('merge-status').textContent = 'Processando mesclagem...';

        const result = await response.json();

        if (response.ok && result.success) {
            document.getElementById('merge-progress').style.width = '100%';
            document.getElementById('merge-status').innerHTML = `
                <span class="text-green-600 dark:text-green-400 font-semibold">✓ ${result.message}</span><br>
                <span class="text-sm text-gray-600 dark:text-gray-400">Atualizando página...</span>
            `;

            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(result.message || result.detail || 'Erro desconhecido');
        }
    } catch (error) {
        document.getElementById('merge-progress').style.width = '0%';
        document.getElementById('merge-status').innerHTML = `
            <span class="text-red-600 dark:text-red-400 font-semibold">✗ Erro: ${error.message}</span><br>
            <button onclick="mergeStep2()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg">Tentar Novamente</button>
        `;
    }
}
</script>
{% endblock %}
