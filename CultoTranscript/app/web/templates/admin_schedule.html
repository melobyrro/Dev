{% extends "base.html" %}

{% block title %}Configuração de Agendamento - CultoTranscript{% endblock %}

{% block extra_css %}
<style>
.config-form {
    max-width: 600px;
    margin: 2rem auto;
    background: var(--surface);
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 1.5rem;
}

.form-section label {
    display: block;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.form-section select,
.form-section input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
    background: var(--surface);
    color: var(--text);
}

.form-section .help-text {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkbox-wrapper input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.save-button {
    width: 100%;
    padding: 1rem;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
}

.save-button:hover {
    background: #229954;
}

.save-button:disabled {
    background: #95a5a6;
    cursor: not-allowed;
}

.status-message {
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    text-align: center;
}

.status-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.loading {
    text-align: center;
    padding: 2rem;
}

.day-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5rem;
}

.day-option {
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 4px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
    color: var(--text);
}

.day-option:hover {
    border-color: var(--primary);
    background: var(--muted);
}

.day-option.selected {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>⏰ Configuração de Agendamento Automático</h2>
    <p>Configure quando o sistema deve verificar o canal para novos vídeos automaticamente.</p>
</div>

<!-- Scheduler Status Widget -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6" style="max-width: 600px; margin: 2rem auto;">
    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
        Status do Agendamento
    </h3>

    <div id="scheduler-status" class="space-y-3">
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-400">Status:</span>
            <span id="status-indicator" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                Carregando...
            </span>
        </div>

        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-400">Última verificação:</span>
            <span id="last-check" class="text-sm font-medium text-gray-900 dark:text-white">
                --
            </span>
        </div>

        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-400">Próxima verificação:</span>
            <span id="next-run" class="text-sm font-medium text-gray-900 dark:text-white">
                --
            </span>
        </div>
    </div>
</div>

<div class="config-form">
    <div id="statusMessage" style="display: none;"></div>

    <div id="loadingIndicator" class="loading">
        <div class="progress-indicator"></div>
        Carregando configurações...
    </div>

    <form id="scheduleForm" style="display: none;">
        <div class="form-section">
            <label>Dia da Semana</label>
            <div class="day-grid">
                <div class="day-option" data-day="0">Segunda</div>
                <div class="day-option" data-day="1">Terça</div>
                <div class="day-option" data-day="2">Quarta</div>
                <div class="day-option" data-day="3">Quinta</div>
                <div class="day-option" data-day="4">Sexta</div>
                <div class="day-option" data-day="5">Sábado</div>
                <div class="day-option" data-day="6">Domingo</div>
            </div>
            <p class="help-text">Selecione o dia da semana para verificar novos vídeos</p>
        </div>

        <div class="form-section">
            <label for="timeInput">Horário</label>
            <input type="time" id="timeInput" required>
            <p class="help-text">Horário em que a verificação será executada</p>
        </div>

        <div class="form-section">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="enabledCheckbox">
                <label for="enabledCheckbox" style="margin: 0;">Agendamento ativo</label>
            </div>
            <p class="help-text">Desmarque para desativar temporariamente</p>
        </div>

        <button type="submit" class="save-button" id="saveButton">
            Salvar Configuração
        </button>
    </form>
</div>

<script>
let selectedDay = 0;
let csrfToken = null;

// Refresh CSRF token
async function refreshCsrfToken() {
    try {
        const response = await fetch('/api/csrf-token');
        const data = await response.json();
        csrfToken = data.csrf_token;
        console.log('CSRF token refreshed');
    } catch (error) {
        console.error('Error refreshing CSRF token:', error);
    }
}

// Load current configuration
async function loadConfig() {
    try {
        const response = await fetch('/api/schedule-config');
        const data = await response.json();

        if (data) {
            selectedDay = data.day_of_week !== null ? data.day_of_week : 0;

            // Set selected day
            document.querySelectorAll('.day-option').forEach(opt => {
                const day = parseInt(opt.dataset.day);
                if (day === selectedDay) {
                    opt.classList.add('selected');
                }
            });

            // Set time (remove seconds if present)
            const time = data.time_of_day.substring(0, 5);  // HH:MM:SS -> HH:MM
            document.getElementById('timeInput').value = time;

            // Set enabled
            document.getElementById('enabledCheckbox').checked = data.enabled;

            // Refresh CSRF token after loading config
            await refreshCsrfToken();

            // Show form
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('scheduleForm').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading config:', error);
        showMessage('Erro ao carregar configuração', 'error');
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// Day selection
document.querySelectorAll('.day-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove selection from all
        document.querySelectorAll('.day-option').forEach(opt => {
            opt.classList.remove('selected');
        });

        // Add selection to clicked
        this.classList.add('selected');
        selectedDay = parseInt(this.dataset.day);
    });
});

// Form submission
document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const timeValue = document.getElementById('timeInput').value;
    const enabled = document.getElementById('enabledCheckbox').checked;
    const saveButton = document.getElementById('saveButton');

    // Disable button
    saveButton.disabled = true;
    saveButton.textContent = 'Salvando...';

    try {
        // Refresh CSRF token before save
        await refreshCsrfToken();

        const response = await fetch('/api/schedule-config', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
                day_of_week: selectedDay,
                time_of_day: timeValue,
                enabled: enabled
            })
        });

        const data = await response.json();

        if (data.success) {
            // Show success message from backend (includes reload status)
            const messageType = data.reload_success ? 'success' : 'error';
            showMessage('✓ ' + data.message, messageType);

            // Refresh scheduler status widget
            updateSchedulerStatus();
        } else {
            showMessage('Erro: ' + (data.detail || 'Erro desconhecido'), 'error');
        }
    } catch (error) {
        console.error('Error saving config:', error);
        showMessage('Erro ao salvar configuração. Verifique sua conexão.', 'error');
    } finally {
        // Re-enable button
        saveButton.disabled = false;
        saveButton.textContent = 'Salvar Configuração';
    }
});

function showMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = 'status-message ' + type;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';

    // Auto-hide after 5 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Scheduler status update
async function updateSchedulerStatus() {
    try {
        const response = await fetch('/api/scheduler-status');
        const data = await response.json();

        const statusIndicator = document.getElementById('status-indicator');
        const lastCheck = document.getElementById('last-check');
        const nextRun = document.getElementById('next-run');

        if (data.scheduler_running) {
            statusIndicator.textContent = 'Ativo';
            statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        } else {
            statusIndicator.textContent = 'Inativo';
            statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        }

        if (data.last_check) {
            const lastCheckDate = new Date(data.last_check);
            lastCheck.textContent = lastCheckDate.toLocaleString('pt-BR');
        } else {
            lastCheck.textContent = 'Nunca';
        }

        if (data.next_run) {
            const nextRunDate = new Date(data.next_run);
            nextRun.textContent = nextRunDate.toLocaleString('pt-BR');
        } else {
            nextRun.textContent = data.schedule_enabled ? 'Aguardando...' : 'Desabilitado';
        }
    } catch (error) {
        console.error('Failed to fetch scheduler status:', error);
        const statusIndicator = document.getElementById('status-indicator');
        statusIndicator.textContent = 'Erro';
        statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
    }
}

// Update on page load and every 30 seconds
updateSchedulerStatus();
setInterval(updateSchedulerStatus, 30000);

// Load on page load
loadConfig();
</script>
{% endblock %}
