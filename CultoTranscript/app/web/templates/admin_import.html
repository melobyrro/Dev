{% extends "base.html" %}

{% block title %}Admin - Importar V√≠deos{% endblock %}

{% block content %}
<div class="card">
    <h1>üîê Painel Administrativo - Importar V√≠deos</h1>
    <p style="color: var(--text-muted); margin-top: 0.5rem;">Esta √°rea √© restrita a administradores. Importe v√≠deos do canal configurado.</p>
</div>

<!-- Channel Header -->
{% if channel %}
<div class="card channel-header-banner">
    <h2 style="margin-bottom: 0.5rem;">üì∫ {{ channel.title }}</h2>
    <p class="text-secondary" style="margin-bottom: 1rem;">{{ channel.youtube_url }}</p>
    <div style="display: flex; gap: 1rem; font-size: 0.95rem;">
        <div>üìä <strong>{{ total_videos }}</strong> v√≠deos</div>
        <div>‚úÖ <strong>{{ completed_videos }}</strong> processados</div>
        {% if channel.last_checked_at %}
        <div>üîÑ √öltima verifica√ß√£o: {{ channel.last_checked_at.strftime('%m/%d/%Y %H:%M') }}</div>
        {% endif %}
    </div>
</div>
{% else %}
<div class="card">
    <h2>‚öôÔ∏è Configurar Canal</h2>
    <p>Nenhum canal configurado. Configure um canal para come√ßar a importar v√≠deos.</p>
    <form id="setupChannelForm" style="margin-top: 1rem;">
        <div class="form-group">
            <label for="channelTitle">Nome do Canal</label>
            <input type="text" id="channelTitle" placeholder="Ex: Igreja Exemplo" required>
        </div>
        <div class="form-group">
            <label for="channelUrl">URL do Canal no YouTube</label>
            <input type="url" id="channelUrl" placeholder="https://www.youtube.com/@nome_do_canal" required>
        </div>
        <button type="submit" class="btn">Configurar Canal</button>
    </form>
    <div id="setupStatus" style="margin-top: 1rem;"></div>
</div>
{% endif %}

<!-- Import Options -->
{% if channel %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Single Video Import -->
    <div class="card">
        <h2>üìπ Importar 1 V√≠deo</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Adicione um v√≠deo espec√≠fico pela URL do YouTube</p>
        <form id="transcribeForm">
            <div class="form-group">
                <label for="url">URL do V√≠deo</label>
                <input type="url" id="url" name="url" placeholder="https://www.youtube.com/watch?v=..." required>
            </div>
            <button type="submit" class="btn">Importar V√≠deo</button>
        </form>
        <div id="singleStatus" style="margin-top: 1rem;"></div>
        <div id="progressTracker" style="display: none;"></div>
    </div>

    <!-- Bulk Channel Import -->
    <div class="card">
        <h2>üìö Importar do Canal</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Importe v√°rios v√≠deos publicados em um per√≠odo espec√≠fico</p>
        <form id="bulkImportForm">
            <div class="form-group">
                <label for="dateStart">Data In√≠cio (publica√ß√£o no YouTube)</label>
                <input type="date" id="dateStart" required>
            </div>
            <div class="form-group">
                <label for="dateEnd">Data Fim</label>
                <input type="date" id="dateEnd" required>
            </div>
            <div class="form-group">
                <label for="maxVideos">Limite de V√≠deos (opcional)</label>
                <input type="number" id="maxVideos" min="1" max="500" placeholder="Ex: 50">
                <small style="color: var(--text-muted);">Deixe vazio para importar todos do per√≠odo</small>
            </div>
            <button type="submit" class="btn">Iniciar Importa√ß√£o</button>
        </form>
        <div id="bulkStatus" style="margin-top: 1rem;"></div>
    </div>
</div>

<div class="card">
    <p style="text-align: center; margin: 2rem 0;">
        <a href="/" class="btn btn-secondary">‚Üê Voltar ao Dashboard</a>
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
/* Channel Header Banner */
.channel-header-banner {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    margin: -1.5rem -1.5rem 2rem -1.5rem;
    padding: 2rem;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .channel-header-banner {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

/* Semantic Status Classes */
.status-info {
    color: #3b82f6;
}

.status-success {
    color: #10b981;
}

.status-error {
    color: #ef4444;
}

[data-theme="dark"] .status-info {
    color: #60a5fa;
}

[data-theme="dark"] .status-success {
    color: #34d399;
}

[data-theme="dark"] .status-error {
    color: #f87171;
}

/* Progress Item Classes */
.progress-item {
    background: var(--surface);
    border-left: 4px solid #3b82f6;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
}

[data-theme="dark"] .progress-item {
    border-left-color: #60a5fa;
}

.progress-item-header {
    background: var(--muted);
    padding: 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.progress-item-bar {
    background: #3b82f6;
    height: 4px;
    border-radius: 2px;
    transition: width 0.3s ease;
}

[data-theme="dark"] .progress-item-bar {
    background: #60a5fa;
}

/* Progress Indicator */
.progress-indicator {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f39c12;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Progress tracking styles */
.progress-tracker {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
}

.progress-step {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--muted);
    border-radius: 4px;
    border: 1px solid var(--border);
}

.step-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 16px;
    flex-shrink: 0;
}

.step-icon.pending {
    background: var(--muted);
    color: var(--text-muted);
}

.step-icon.running {
    background: #f39c12;
    color: white;
    animation: pulse 1.5s ease-in-out infinite;
}

.step-icon.completed {
    background: #10b981;
    color: white;
}

[data-theme="dark"] .step-icon.completed {
    background: #10b981;
}

.step-icon.failed {
    background: #ef4444;
    color: white;
}

[data-theme="dark"] .step-icon.failed {
    background: #ef4444;
}

[data-theme="dark"] .step-icon.running {
    background: #f39c12;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.step-content {
    flex: 1;
}

.step-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.step-estimate {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background: var(--muted);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.progress-bar {
    height: 100%;
    background: #3498db;
    transition: width 0.3s ease;
}

.progress-bar.completed {
    background: #10b981;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const CHANNEL_ID = {{ channel.id if channel else 'null' }};
let activeJobIds = new Set();
let pollInterval = null;

// Handle channel setup form (when no channel exists)
{% if not channel %}
document.getElementById('setupChannelForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('channelTitle').value;
    const url = document.getElementById('channelUrl').value;
    const statusDiv = document.getElementById('setupStatus');

    statusDiv.innerHTML = '<p class="status-info">‚è≥ Configurando canal...</p>';

    try {
        const response = await fetch('/api/channels/setup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title, youtube_url: url })
        });

        const data = await response.json();

        if (data.success) {
            statusDiv.innerHTML = '<p class="status-success">‚úÖ Canal configurado! Recarregando...</p>';
            setTimeout(() => window.location.reload(), 1500);
        } else {
            statusDiv.innerHTML = `<p class="status-error">‚ùå Erro: ${data.detail || 'Falha ao configurar canal'}</p>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<p class="status-error">‚ùå Erro: ${error.message}</p>`;
    }
});
{% endif %}

// Handle single video transcription form
{% if channel %}
document.getElementById('transcribeForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const url = document.getElementById('url').value;
    const statusDiv = document.getElementById('singleStatus');
    const progressTracker = document.getElementById('progressTracker');

    statusDiv.innerHTML = '<p class="status-info"><span class="progress-indicator"></span>Iniciando transcri√ß√£o...</p>';
    progressTracker.style.display = 'none';

    try {
        const response = await fetch('/api/transcribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url, channel_id: CHANNEL_ID })
        });

        const data = await response.json();

        if (data.success) {
            statusDiv.innerHTML = `<p class="status-success"><span class="progress-indicator"></span>Transcri√ß√£o iniciada! Acompanhe o progresso abaixo...</p>`;
            activeJobIds.add(data.job_id);

            // Show progress tracker with initial steps
            progressTracker.style.display = 'block';
            progressTracker.innerHTML = renderProgressTracker({
                total_steps: 6,
                current_step: "1",
                step_status: "queued",
                step_message: "Aguardando in√≠cio do processamento...",
                steps: {
                    "1": {"name": "Extrair metadados", "status": "pending", "estimate": "5-10s"},
                    "2": {"name": "Validar dura√ß√£o", "status": "pending", "estimate": "1s"},
                    "3": {"name": "Obter transcri√ß√£o", "status": "pending", "estimate": "10-30s"},
                    "4": {"name": "Detectar in√≠cio do serm√£o", "status": "pending", "estimate": "5-10s"},
                    "5": {"name": "An√°lise avan√ßada com IA", "status": "pending", "estimate": "30-60s"},
                    "6": {"name": "Gerar embeddings", "status": "pending", "estimate": "10-20s"}
                }
            });

            startPolling();
            document.getElementById('url').value = '';
        } else {
            statusDiv.innerHTML = `<p class="status-error">Erro: ${data.detail || 'Falha ao iniciar transcri√ß√£o'}</p>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<p class="status-error">Erro: ${error.message}</p>`;
    }
});

// Handle bulk channel import form
document.getElementById('bulkImportForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const dateStart = document.getElementById('dateStart').value;
    const dateEnd = document.getElementById('dateEnd').value;
    const maxVideos = document.getElementById('maxVideos').value || null;
    const statusDiv = document.getElementById('bulkStatus');

    statusDiv.innerHTML = '<p class="status-info">‚è≥ Iniciando importa√ß√£o em lote...</p>';

    try {
        const response = await fetch('/api/channels/bulk-import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                channel_id: CHANNEL_ID,
                date_start: dateStart,
                date_end: dateEnd,
                max_videos: maxVideos ? parseInt(maxVideos) : null
            })
        });

        const data = await response.json();

        if (data.success && data.job_id) {
            statusDiv.innerHTML = `<p class="status-success">‚úÖ Importa√ß√£o iniciada! Monitorando progresso...</p>`;

            // Clear form
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            document.getElementById('maxVideos').value = '';

            // Start polling for progress
            pollBulkImportProgress(data.job_id, statusDiv);
        } else {
            statusDiv.innerHTML = `<p class="status-error">‚ùå Erro: ${data.detail || 'Falha ao iniciar importa√ß√£o'}</p>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<p class="status-error">‚ùå Erro: ${error.message}</p>`;
    }
});

// Poll bulk import progress
let bulkImportPollInterval = null;
async function pollBulkImportProgress(jobId, statusDiv) {
    // Clear any existing interval
    if (bulkImportPollInterval) {
        clearInterval(bulkImportPollInterval);
    }

    const updateProgress = async () => {
        try {
            const response = await fetch(`/api/jobs/${jobId}/status`);
            const data = await response.json();

            if (data.status === 'running' || data.status === 'queued') {
                const meta = data.metadata || {};
                const progress = meta.progress || 0;
                const message = meta.message || 'Processando...';
                const details = meta.details || '';
                const currentVideo = meta.current_video || 0;
                const newVideos = meta.new_videos || 0;
                const totalVideos = meta.total_videos || 0;
                const videoTitle = meta.current_video_title || '';

                let progressHtml = `
                    <div class="progress-item">
                        <p style="margin: 0.5rem 0;"><strong>Status:</strong> ${message}</p>
                        <div class="progress-item-header">
                            <div class="progress-item-bar" style="width: ${progress}%"></div>
                        </div>
                        <p style="margin: 0.5rem 0; font-size: 0.9em;" class="text-secondary">${progress}% conclu√≠do</p>
                `;

                if (totalVideos > 0) {
                    progressHtml += `<p style="margin: 0.5rem 0; font-size: 0.9em;"><strong>Total encontrado:</strong> ${totalVideos} v√≠deos</p>`;
                }

                if (newVideos > 0 && currentVideo > 0) {
                    progressHtml += `
                        <p style="margin: 0.5rem 0;"><strong>Processando:</strong> V√≠deo ${currentVideo} de ${newVideos}</p>
                        <p style="margin: 0.5rem 0; font-size: 0.9em;" class="text-secondary">${videoTitle}</p>
                    `;
                }

                progressHtml += `</div>`;
                statusDiv.innerHTML = progressHtml;

            } else if (data.status === 'completed') {
                clearInterval(bulkImportPollInterval);
                const meta = data.metadata || {};
                const newVideos = meta.new_videos || 0;
                statusDiv.innerHTML = `
                    <p class="status-success">‚úÖ Importa√ß√£o conclu√≠da! ${newVideos} v√≠deos foram enfileirados para transcri√ß√£o.</p>
                `;
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);

            } else if (data.status === 'failed') {
                clearInterval(bulkImportPollInterval);
                statusDiv.innerHTML = `<p class="status-error">‚ùå Importa√ß√£o falhou: ${data.error || 'Erro desconhecido'}</p>`;
            }
        } catch (error) {
            console.error('Error polling job status:', error);
        }
    };

    // Initial update
    await updateProgress();

    // Poll every 1 second
    bulkImportPollInterval = setInterval(updateProgress, 1000);
}
{% endif %}

// Render progress tracker
function renderProgressTracker(metadata) {
    if (!metadata || !metadata.steps) return '';

    const totalSteps = metadata.total_steps || 6;
    const currentStep = parseInt(metadata.current_step || 0);
    const overallProgress = (currentStep / totalSteps) * 100;

    let stepsHtml = '';
    for (let i = 1; i <= totalSteps; i++) {
        const step = metadata.steps[i.toString()];
        if (!step) continue;

        const status = step.status || 'pending';
        const icon = {
            'pending': '‚è∏Ô∏è',
            'running': '‚è≥',
            'completed': '‚úÖ',
            'failed': '‚ùå'
        }[status] || '‚Ä¢';

        stepsHtml += `
            <div class="progress-step">
                <div class="step-icon ${status}">
                    ${icon}
                </div>
                <div class="step-content">
                    <div class="step-name">${i}. ${step.name}</div>
                    <div class="step-estimate">Tempo estimado: ${step.estimate}</div>
                    ${status === 'running' ? `
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 50%;"></div>
                        </div>
                    ` : ''}
                    ${status === 'completed' ? `
                        <div class="progress-bar-container">
                            <div class="progress-bar completed" style="width: 100%;"></div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    return `
        <div class="progress-tracker">
            <h3>Progresso da Transcri√ß√£o</h3>
            <p><strong>Etapa atual:</strong> ${metadata.step_message || 'Processando...'}</p>
            <div class="progress-bar-container" style="margin-bottom: 1.5rem;">
                <div class="progress-bar" style="width: ${overallProgress}%;"></div>
            </div>
            ${stepsHtml}
        </div>
    `;
}

// Poll job statuses
async function pollJobStatuses() {
    if (activeJobIds.size === 0) {
        stopPolling();
        return;
    }

    for (const jobId of activeJobIds) {
        try {
            const response = await fetch(`/api/jobs/${jobId}/status`);
            const data = await response.json();

            const statusDiv = document.getElementById('singleStatus');
            const progressTracker = document.getElementById('progressTracker');

            if (data.status === 'completed') {
                activeJobIds.delete(jobId);
                statusDiv.innerHTML = '<p class="status-success">‚úÖ Transcri√ß√£o conclu√≠da com sucesso!</p>';
                progressTracker.style.display = 'none';
                setTimeout(() => statusDiv.innerHTML = '', 5000);
            } else if (data.status === 'failed') {
                activeJobIds.delete(jobId);
                statusDiv.innerHTML = `<p class="status-error">‚ùå Transcri√ß√£o falhou: ${data.error || 'Erro desconhecido'}</p>`;
                progressTracker.style.display = 'none';
            } else if (data.status === 'running') {
                statusDiv.innerHTML = `<p class="status-info"><span class="progress-indicator"></span>${data.progress || 'Processando...'}</p>`;
                if (data.metadata) {
                    progressTracker.innerHTML = renderProgressTracker(data.metadata);
                }
            } else if (data.status === 'queued') {
                statusDiv.innerHTML = '<p class="status-info">üìã Aguardando na fila...</p>';
            }
        } catch (error) {
            console.error('Error polling job:', error);
        }
    }
}

function startPolling() {
    if (!pollInterval) {
        pollInterval = setInterval(pollJobStatuses, 2000); // Poll every 2 seconds
    }
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}
</script>
{% endblock %}
