{% extends "base.html" %}

{% block title %}M√©tricas do Chatbot - Admin{% endblock %}

{% block extra_css %}
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin: 0.5rem 0;
    }

    .metric-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table-container {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        overflow-x: auto;
    }

    .queries-table {
        width: 100%;
        border-collapse: collapse;
    }

    .queries-table th,
    .queries-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .queries-table th {
        background: var(--background-color);
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .queries-table tr:hover {
        background: var(--hover-color);
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .period-selector {
        margin-bottom: 2rem;
    }

    .period-selector select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--surface-color);
        color: var(--text-primary);
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>üìä M√©tricas do Chatbot</h1>
    <p class="subtitle">Analytics e Performance do Sistema de Q&A</p>

    <div class="period-selector">
        <label for="period">Per√≠odo:</label>
        <select id="period" onchange="loadMetrics()">
            <option value="7">√öltimos 7 dias</option>
            <option value="30" selected>√öltimos 30 dias</option>
            <option value="90">√öltimos 90 dias</option>
        </select>
    </div>

    <div id="loading" class="loading">Carregando m√©tricas...</div>

    <div id="metrics-content" style="display: none;">
        <!-- Summary Cards -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total de Consultas</div>
                <div class="metric-value" id="total-queries">-</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Tempo M√©dio de Resposta</div>
                <div class="metric-value" id="avg-response-time">-</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Taxa de Cache Hit</div>
                <div class="metric-value" id="cache-hit-rate">-</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Feedback Positivo</div>
                <div class="metric-value" id="helpful-percentage">-</div>
            </div>
        </div>

        <!-- Top Queries Table -->
        <div class="table-container">
            <h2>üîç Top 20 Consultas Mais Comuns</h2>
            <table class="queries-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Consulta</th>
                        <th>Quantidade</th>
                        <th>Tempo M√©dio (ms)</th>
                    </tr>
                </thead>
                <tbody id="top-queries-tbody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Filter Usage -->
        <div class="table-container">
            <h2>üéØ Uso de Filtros</h2>
            <table class="queries-table">
                <thead>
                    <tr>
                        <th>Filtro</th>
                        <th>Quantidade</th>
                        <th>% do Total</th>
                    </tr>
                </thead>
                <tbody id="filter-usage-tbody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Backend Distribution -->
        <div class="table-container">
            <h2>‚öôÔ∏è Distribui√ß√£o de Backend</h2>
            <table class="queries-table">
                <thead>
                    <tr>
                        <th>Backend</th>
                        <th>Quantidade</th>
                        <th>% do Total</th>
                    </tr>
                </thead>
                <tbody id="backend-distribution-tbody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Recent Feedback -->
        <div class="table-container">
            <h2>üí¨ Feedback Recente</h2>
            <table class="queries-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Consulta</th>
                        <th>Rating</th>
                        <th>Coment√°rio</th>
                    </tr>
                </thead>
                <tbody id="feedback-tbody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function loadMetrics() {
    const period = document.getElementById('period').value;
    const loading = document.getElementById('loading');
    const content = document.getElementById('metrics-content');

    loading.style.display = 'block';
    content.style.display = 'none';

    try {
        // Fetch metrics data
        const response = await fetch(`/api/admin/chatbot-metrics/data?days=${period}`);
        const data = await response.json();

        if (!data.success) {
            throw new Error('Failed to fetch metrics');
        }

        // Update summary cards
        document.getElementById('total-queries').textContent = data.summary.total_queries.toLocaleString();
        document.getElementById('avg-response-time').textContent = `${data.summary.avg_response_time_ms.toFixed(0)}ms`;
        document.getElementById('cache-hit-rate').textContent = `${data.summary.cache_hit_rate.toFixed(1)}%`;
        document.getElementById('helpful-percentage').textContent = `${data.summary.helpful_percentage.toFixed(1)}%`;

        // Populate top queries table
        const topQueriesTbody = document.getElementById('top-queries-tbody');
        topQueriesTbody.innerHTML = data.top_queries.map((q, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${escapeHtml(q.query)}</td>
                <td>${q.count}</td>
                <td>${q.avg_response_time_ms.toFixed(0)}ms</td>
            </tr>
        `).join('');

        // Populate filter usage table
        const totalQueries = data.summary.total_queries;
        const filterUsageTbody = document.getElementById('filter-usage-tbody');
        filterUsageTbody.innerHTML = `
            <tr>
                <td>üìÖ Filtro de Data</td>
                <td>${data.filter_usage.date_filters}</td>
                <td>${((data.filter_usage.date_filters / totalQueries) * 100).toFixed(1)}%</td>
            </tr>
            <tr>
                <td>üé§ Filtro de Pregador</td>
                <td>${data.filter_usage.speaker_filters}</td>
                <td>${((data.filter_usage.speaker_filters / totalQueries) * 100).toFixed(1)}%</td>
            </tr>
            <tr>
                <td>üìñ Filtro B√≠blico</td>
                <td>${data.filter_usage.biblical_filters}</td>
                <td>${((data.filter_usage.biblical_filters / totalQueries) * 100).toFixed(1)}%</td>
            </tr>
            <tr>
                <td>üé® Filtro de Tema</td>
                <td>${data.filter_usage.theme_filters}</td>
                <td>${((data.filter_usage.theme_filters / totalQueries) * 100).toFixed(1)}%</td>
            </tr>
        `;

        // Populate backend distribution table
        const backendTbody = document.getElementById('backend-distribution-tbody');
        backendTbody.innerHTML = data.backend_distribution.map(bd => `
            <tr>
                <td>${bd.backend}</td>
                <td>${bd.count}</td>
                <td>${((bd.count / totalQueries) * 100).toFixed(1)}%</td>
            </tr>
        `).join('');

        // Fetch and populate recent feedback
        const feedbackResponse = await fetch('/api/admin/chatbot-metrics/feedback?limit=20');
        const feedbackData = await feedbackResponse.json();

        const feedbackTbody = document.getElementById('feedback-tbody');
        feedbackTbody.innerHTML = feedbackData.feedback.map(f => `
            <tr>
                <td>${new Date(f.created_at).toLocaleDateString('pt-BR')}</td>
                <td>${escapeHtml(f.query.substring(0, 50))}...</td>
                <td>${f.rating === 'helpful' ? 'üëç √ötil' : 'üëé N√£o √∫til'}</td>
                <td>${f.feedback_text ? escapeHtml(f.feedback_text.substring(0, 100)) : '-'}</td>
            </tr>
        `).join('');

        loading.style.display = 'none';
        content.style.display = 'block';

    } catch (error) {
        console.error('Error loading metrics:', error);
        loading.innerHTML = '<p style="color: red;">‚ùå Erro ao carregar m√©tricas. Verifique os logs.</p>';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load metrics on page load
document.addEventListener('DOMContentLoaded', loadMetrics);
</script>
{% endblock %}
